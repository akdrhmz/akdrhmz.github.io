<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaspar SatranÃ§ Akademisi</title>
    <!-- Chessboard.js & Chess.js -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --accent-color: #38bdf8;
            --accent-green: #22c55e;
            --text-color: #f8fafc;
            --accent-red: #ef4444;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden; touch-action: none; overscroll-behavior: none;
        }

        .app-container { display: flex; flex-direction: column; height: 100vh; max-width: 600px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* MODALS */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .role-btn {
            background: var(--panel-bg); padding: 20px; margin: 10px; border-radius: 15px;
            width: 250px; text-align: center; cursor: pointer; border: 2px solid transparent;
            transition: 0.2s;
        }
        .role-btn:active { transform: scale(0.95); border-color: var(--accent-color); }
        
        .input-group { margin: 10px 0; width: 80%; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: #020617; color: white; font-size: 1rem; text-align: center; }

        /* GAME UI */
        header {
            padding: 15px; background: var(--panel-bg); border-bottom: 1px solid #334155;
            display: flex; justify-content: space-between; align-items: center;
        }
        .user-badge { background: #334155; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }

        .game-area { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 10px; gap: 15px; }
        
        .kaspar-bubble {
            background: var(--panel-bg); padding: 15px; border-radius: 12px;
            border-left: 4px solid var(--accent-color);
            display: flex; align-items: center; gap: 10px; font-size: 0.95rem;
            min-height: 60px;
        }
        
        .board-wrapper { width: 100%; aspect-ratio: 1; touch-action: none; }
        #board { width: 100%; height: 100%; border-radius: 8px; border: 3px solid #334155; }

        .controls { padding: 15px; display: flex; gap: 10px; background: var(--panel-bg); }
        .btn { background: var(--accent-color); color: #0f172a; border: none; padding: 12px; border-radius: 8px; font-weight: bold; flex: 1; cursor: pointer; }
        .btn-green { background: var(--accent-green); color: white; }
        .btn-red { background: var(--accent-red); color: white; }

        /* LISTS */
        .list-container { width: 100%; padding: 20px; overflow-y: auto; flex: 1; }
        .list-item { 
            background: var(--panel-bg); padding: 15px; margin-bottom: 10px; 
            border-radius: 10px; display: flex; justify-content: space-between; 
            align-items: center; cursor: pointer; 
        }
        .list-item:hover { background: #334155; }
        
        .code-display { font-size: 2rem; letter-spacing: 5px; color: var(--accent-color); font-weight: bold; margin: 20px 0; }
        
        /* ADMIN TABLE */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #334155; }
        th { color: var(--accent-color); }
    </style>
</head>
<body>

    <!-- 1. GÄ°RÄ°Å EKRANI -->
    <div id="screen-home" class="modal">
        <h1 style="color: var(--accent-color);">ğŸ¦ Kaspar</h1>
        <div class="role-btn" onclick="app.showAuth('student')">
            <div style="font-size: 3rem;">ğŸ“</div>
            <h3>Ã–ÄŸrenci GiriÅŸi</h3>
        </div>
        <div class="role-btn" onclick="app.showAuth('parent')">
            <div style="font-size: 2rem;">ğŸ </div>
            <h3>Ebeveyn GiriÅŸi</h3>
        </div>
        <div class="role-btn" onclick="app.showAuth('engineer')">
            <div style="font-size: 2rem;">ğŸ› ï¸</div>
            <h3>MÃ¼hendislik</h3>
        </div>
    </div>

    <!-- 2. AUTH EKRANI -->
    <div id="screen-auth" class="modal hidden">
        <h2 id="auth-title">GiriÅŸ Yap</h2>
        <div style="width:80%;">
            <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±">
            <input type="password" id="password" placeholder="Åifre">
            <button class="btn" onclick="app.login()">GiriÅŸ</button>
            <button class="btn btn-green" id="btn-reg" onclick="app.register()">Yeni KayÄ±t</button>
            <br>
            <button class="btn" style="background:none; color:#888; font-size:0.8rem;" onclick="app.showResetPassword()">Åifremi Unuttum</button>
            <br><br>
            <button onclick="location.reload()" style="background:none; border:none; color:#666;">â† Geri DÃ¶n</button>
        </div>
    </div>

    <!-- 3. OYUN EKRANI -->
    <div id="screen-game" class="app-container hidden">
        <header>
            <span style="font-weight:bold; color:var(--accent-color);">ğŸ¦ Arena</span>
            <div>
                <span class="user-badge" id="game-username">Misafir</span>
                <button onclick="app.showPairingCode()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">ğŸ”—</button>
            </div>
        </header>

        <div class="game-area">
            <div class="kaspar-bubble">
                <span style="font-size: 2rem;">ğŸ¦</span>
                <div id="kaspar-text">Merhaba! HazÄ±rsan baÅŸlayalÄ±m.</div>
            </div>
            <div class="board-wrapper"><div id="board"></div></div>
            <div style="text-align:center; color:#94a3b8; font-size:0.9rem;" id="game-status">SÄ±ra Beyazda</div>
        </div>

        <div class="controls">
            <button class="btn" style="background:#475569; color:white;" onclick="app.resetGame()">Yeni</button>
            <button class="btn btn-green" onclick="app.askHint()">Ä°pucu</button>
            <button class="btn btn-red" onclick="location.reload()">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
    </div>

    <!-- 4. EBEVEYN PANELÄ° -->
    <div id="screen-parent" class="app-container hidden">
        <header>
            <span>ğŸ“Š Veli Paneli</span>
            <button onclick="location.reload()" style="background:none; border:none; color:white;">Ã‡Ä±kÄ±ÅŸ</button>
        </header>
        <div class="list-container" id="student-list"></div>
        <div style="padding:20px;">
            <button class="btn btn-green" onclick="app.showAddStudent()">â• Ã–ÄŸrenci Ekle</button>
        </div>
    </div>

    <!-- 5. ADMIN PANELÄ° (MÃœHENDÄ°S) -->
    <div id="screen-admin" class="app-container hidden">
        <header>
            <span style="color:#ef4444;">ğŸ› ï¸ Sistem YÃ¶netimi</span>
            <button onclick="location.reload()" style="background:none; border:none; color:white;">Ã‡Ä±kÄ±ÅŸ</button>
        </header>
        <div class="list-container">
            <h3>TÃ¼m KullanÄ±cÄ±lar</h3>
            <div id="admin-user-list"></div>
        </div>
    </div>

    <!-- MODALS (Code, Add Student, Report, Reset Password) -->
    <div id="modal-code" class="modal hidden">
        <div class="card" style="cursor:default;">
            <h3>Velini BaÄŸla</h3>
            <p>Bu kodu veline ver:</p>
            <div class="code-display" id="pairing-code">...</div>
            <button class="btn" onclick="document.getElementById('modal-code').classList.add('hidden')">Tamam</button>
        </div>
    </div>

    <div id="modal-add-student" class="modal hidden">
        <div class="card" style="cursor:default;">
            <h3>Ã–ÄŸrenci Ekle</h3>
            <input type="text" id="link-code" placeholder="KOD (Ã–rn: X7B9A)">
            <button class="btn btn-green" onclick="app.linkStudent()">Ekle</button>
            <button class="btn" onclick="document.getElementById('modal-add-student').classList.add('hidden')">Ä°ptal</button>
        </div>
    </div>
    
    <div id="modal-report" class="modal hidden">
        <div class="card" style="width:90%; max-width:400px; cursor:default; text-align:left;">
            <h3 id="rep-name" style="color:var(--accent-color);">Rapor</h3>
            <div id="rep-content" style="line-height:1.6;"></div>
            <hr style="border-color:#444; margin:15px 0;">
            <button class="btn" onclick="app.showResetPassword(currentReportId)">Åifre SÄ±fÄ±rla</button>
            <button class="btn btn-red" onclick="document.getElementById('modal-report').classList.add('hidden')">Kapat</button>
        </div>
    </div>

    <div id="modal-reset-pw" class="modal hidden">
        <div class="card" style="cursor:default;">
            <h3>Åifre SÄ±fÄ±rla</h3>
            <input type="text" id="reset-username" placeholder="KullanÄ±cÄ± AdÄ±" disabled style="opacity:0.5;">
            <input type="password" id="new-password" placeholder="Yeni Åifre">
            <button class="btn btn-green" onclick="app.doResetPassword()">GÃ¼ncelle</button>
            <button class="btn" onclick="document.getElementById('modal-reset-pw').classList.add('hidden')">Ä°ptal</button>
        </div>
    </div>

    <script>
        const API_URL = "https://kadir-pc.taildc8da7.ts.net/api";
        const API_KEY = "kaspar_sec_eb82b49055236a3a862f42e53e8e8b97";
        let currentReportId = null;

        class App {
            constructor() {
                this.user = null;
                this.role = null;
                this.game = new Chess();
                this.board = null;
            }

            // --- AUTH ---
            showAuth(role) {
                this.role = role;
                document.getElementById('screen-home').classList.add('hidden');
                document.getElementById('screen-auth').classList.remove('hidden');
                document.getElementById('auth-title').innerText = role === 'engineer' ? 'MÃ¼hendis GiriÅŸi' : (role === 'parent' ? 'Veli GiriÅŸi' : 'Ã–ÄŸrenci GiriÅŸi');
                
                if(role === 'parent' || role === 'engineer') document.getElementById('btn-reg').classList.add('hidden');
                else document.getElementById('btn-reg').classList.remove('hidden');
            }

            async login() {
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                if(!u || !p) return alert("Bilgileri girin.");

                // MÃ¼hendis iÃ§in hardcoded backdoor (VeritabanÄ± yoksa diye)
                if(this.role === 'engineer' && u === 'jarvis' && p === 'master') {
                    this.user = { user_id: 0, username: 'Jarvis', role: 'engineer' };
                    this.initAdmin();
                    return;
                }

                const res = await this.post('/auth/login', { username: u, password: p });
                if (res.status === 'success') {
                    this.user = res;
                    this.role = res.role;
                    document.getElementById('screen-auth').classList.add('hidden');
                    
                    if (this.role === 'student') this.initGame();
                    else if (this.role === 'parent') this.initParent();
                    else if (this.role === 'engineer') this.initAdmin();
                } else alert(res.message);
            }

            async register() {
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                const res = await this.post('/auth/register', { username: u, password: p, role: 'student' });
                alert(res.message);
            }

            // --- STUDENT ---
            initGame() {
                document.getElementById('screen-game').classList.remove('hidden');
                document.getElementById('game-username').innerText = this.user.username;
                setTimeout(() => this.initBoard(), 200);
            }

            async showPairingCode() {
                const res = await this.post('/auth/code/generate', { user_id: this.user.user_id });
                document.getElementById('pairing-code').innerText = res.code;
                document.getElementById('modal-code').classList.remove('hidden');
            }
            
            // --- PARENT ---
            async initParent() {
                document.getElementById('screen-parent').classList.remove('hidden');
                this.loadMyStudents();
            }

            async loadMyStudents() {
                const res = await this.post('/parent/my_students', { parent_id: this.user.user_id });
                const list = document.getElementById('student-list');
                list.innerHTML = '';
                
                if (res.students && res.students.length > 0) {
                    res.students.forEach(s => {
                        const d = document.createElement('div');
                        d.className = 'list-item';
                        d.innerHTML = `<span>ğŸ“ ${s.username}</span><span>Level ${s.current_level}</span>`;
                        d.onclick = () => this.showReport(s.id, s.username);
                        list.appendChild(d);
                    });
                } else {
                    list.innerHTML = '<div style="text-align:center; color:#888;">HenÃ¼z ekli Ã¶ÄŸrenci yok.</div>';
                }
            }

            async showReport(id, name) {
                currentReportId = id;
                document.getElementById('modal-report').classList.remove('hidden');
                document.getElementById('rep-content').innerHTML = 'YÃ¼kleniyor...';
                document.getElementById('rep-name').innerText = name;
                
                const res = await this.post('/parent/report', { student_id: id });
                document.getElementById('rep-content').innerHTML = `
                    <p><b>Toplam Oyun:</b> ${res.total_games}</p>
                    <p><b>Galibiyet:</b> ${res.wins}</p>
                    <div style="background:#334155; padding:10px; border-radius:8px; margin-top:10px; font-style:italic;">
                        "${res.kaspar_comment}"
                    </div>
                `;
            }

            showAddStudent() {
                document.getElementById('modal-add-student').classList.remove('hidden');
            }

            async linkStudent() {
                const code = document.getElementById('link-code').value;
                const res = await this.post('/auth/code/claim', { parent_id: this.user.user_id, code: code });
                alert(res.message);
                if (res.status === 'success') {
                    document.getElementById('modal-add-student').classList.add('hidden');
                    this.loadMyStudents();
                }
            }

            // --- ADMIN ---
            async initAdmin() {
                document.getElementById('screen-auth').classList.add('hidden');
                document.getElementById('screen-admin').classList.remove('hidden');
                
                const res = await this.post('/admin/users', { role: 'engineer' });
                const list = document.getElementById('admin-user-list');
                
                let html = '<table><tr><th>ID</th><th>KullanÄ±cÄ±</th><th>Rol</th><th>Level</th><th>Ä°ÅŸlem</th></tr>';
                res.users.forEach(u => {
                    html += `<tr>
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.role}</td>
                        <td>${u.current_level}</td>
                        <td><button class="btn" style="padding:5px; font-size:0.8rem;" onclick="app.showResetPassword(${u.id}, '${u.username}')">Åifre</button></td>
                    </tr>`;
                });
                html += '</table>';
                list.innerHTML = html;
            }

            // --- PASSWORD RESET ---
            showResetPassword(targetId = null, targetName = null) {
                // EÄŸer parametre yoksa, "Åifremi Unuttum" butonundan gelmiÅŸtir (kendi ÅŸifresi iÃ§in deÄŸil, destek iÃ§in)
                // Ama ÅŸu anki akÄ±ÅŸta "Åifremi Unuttum" sadece bir iletiÅŸim kutusu aÃ§malÄ± Ã§Ã¼nkÃ¼ e-posta yok.
                // Biz burada "Veli Ã§ocuÄŸunun ÅŸifresini deÄŸiÅŸtiriyor" veya "Admin deÄŸiÅŸtiriyor" senaryosunu yapÄ±yoruz.
                
                if (!this.user && !targetId) {
                    alert("LÃ¼tfen yÃ¶neticinizle (Kadir Hoca) iletiÅŸime geÃ§in.");
                    return;
                }

                currentReportId = targetId || this.user.user_id; // Ya hedef ya kendisi
                const name = targetName || (this.user ? this.user.username : 'KullanÄ±cÄ±');
                
                document.getElementById('modal-reset-pw').classList.remove('hidden');
                document.getElementById('reset-username').value = name;
                document.getElementById('new-password').value = '';
                document.getElementById('new-password').focus();
            }

            async doResetPassword() {
                const newPw = document.getElementById('new-password').value;
                if(!newPw) return alert("Yeni ÅŸifreyi girin.");
                
                const res = await this.post('/auth/password/reset', {
                    requester_id: this.user.user_id,
                    requester_role: this.user.role,
                    target_user_id: currentReportId,
                    new_password: newPw
                });
                
                alert(res.message);
                if(res.status === 'success') document.getElementById('modal-reset-pw').classList.add('hidden');
            }

            // --- GAME LOGIC ---
            initBoard() {
                if(this.board) this.board.destroy();
                this.board = Chessboard('board', {
                    draggable: true, position: 'start',
                    onDrop: (s, t) => {
                        const m = this.game.move({ from: s, to: t, promotion: 'q' });
                        if (!m) return 'snapback';
                        this.updateStatus();
                        if (!this.game.game_over()) this.makeAiMove();
                        else this.endGame();
                    }
                });
                document.getElementById('board').addEventListener('touchmove', e => e.preventDefault(), {passive:false});
                window.addEventListener('resize', () => this.board.resize());
            }

            async makeAiMove() {
                document.getElementById('kaspar-text').innerText = "DÃ¼ÅŸÃ¼nÃ¼yorum...";
                const res = await this.post('/move', { fen: this.game.fen(), user_id: this.user.user_id });
                if (res.status === 'success') {
                    this.game.move(res.best_move, { sloppy: true });
                    this.board.position(this.game.fen());
                    document.getElementById('kaspar-text').innerText = res.comment;
                    this.updateStatus();
                    if(this.game.game_over()) this.endGame();
                }
            }

            async endGame() {
                let r = 'draw';
                if(this.game.in_checkmate()) r = this.game.turn() === 'w' ? 'loss' : 'win';
                await this.post('/game/end', { user_id: this.user.user_id, result: r, moves: this.game.history().length });
                document.getElementById('kaspar-text').innerHTML = `<b>OYUN BÄ°TTÄ°!</b>`;
            }

            updateStatus() {
                let s = this.game.turn() === 'w' ? "SÄ±ra Beyazda" : "SÄ±ra Siyahda";
                if(this.game.in_check()) s += " (ÅAH!)";
                document.getElementById('game-status').innerText = s;
            }

            resetGame() { this.game.reset(); this.board.start(); this.updateStatus(); document.getElementById('kaspar-text').innerText = "Yeni Oyun!"; }
            async askHint() { const r = await this.post('/hint', {fen:this.game.fen()}); if(r.status==='success') alert(r.hint); }

            async post(ep, data={}) {
                try {
                    const r = await fetch(API_URL + ep, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Kaspar-Key': API_KEY },
                        body: JSON.stringify(data)
                    });
                    return await r.json();
                } catch(e) { return {status:'error', message:'BaÄŸlantÄ± hatasÄ±'}; }
            }
        }
        window.app = new App();
    </script>
</body>
</html>
