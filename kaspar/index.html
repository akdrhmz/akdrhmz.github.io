<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaspar Satran√ß Akademisi</title>
    <!-- Chessboard.js & Chess.js -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --accent-color: #38bdf8;
            --text-color: #f8fafc;
            --board-border: #334155;
        }

        /* Mobil Optimize: Kaydƒ±rmayƒ± engelle */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', system-ui, sans-serif;
            touch-action: none; /* T√ºm sayfada zoom/pan engelle */
            overscroll-behavior: none;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
        }

        /* Header */
        header {
            padding: 10px 15px;
            background: var(--panel-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--board-border);
            z-index: 10;
        }

        .brand { font-size: 1.2rem; font-weight: bold; color: var(--accent-color); display: flex; align-items: center; gap: 8px; }
        .connection-dot { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; display: inline-block; }
        .online { background: #22c55e; box-shadow: 0 0 5px #22c55e; }

        /* Main Game Area */
        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            gap: 15px;
        }

        .board-container {
            width: 100%;
            aspect-ratio: 1;
            max-height: 70vh;
            touch-action: none; /* Tahtada dokunmayƒ± browser'a bƒ±rakma */
        }

        /* Kaspar Bubble */
        .kaspar-bubble {
            background: var(--panel-bg);
            padding: 12px;
            border-radius: 12px;
            border-left: 4px solid var(--accent-color);
            width: 100%;
            min-height: 50px;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        /* Controls */
        .controls {
            padding: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            background: var(--panel-bg);
            border-top: 2px solid var(--board-border);
        }

        .btn {
            background: var(--accent-color);
            color: #0f172a;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            flex: 1;
            max-width: 150px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-secondary { background: #475569; color: white; }

        /* Login Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .role-card {
            background: var(--panel-bg);
            padding: 20px;
            margin: 10px;
            border-radius: 15px;
            width: 250px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .role-card:hover { border-color: var(--accent-color); }
        
        .hidden { display: none !important; }
        .thinking { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    </style>
</head>
<body>

    <!-- Login Screen -->
    <div id="login-screen" class="modal">
        <h1 style="color: var(--accent-color); margin-bottom: 30px;">ü¶Å Kaspar Akademi</h1>
        <div class="role-card" onclick="app.login('student')">
            <div style="font-size: 3rem;">üéì</div>
            <h3>√ñƒürenci</h3>
        </div>
        <div class="role-card" onclick="app.login('parent')">
            <div style="font-size: 3rem;">üè†</div>
            <h3>Ebeveyn</h3>
        </div>
        <div class="role-card" onclick="app.login('engineer')">
            <div style="font-size: 3rem;">üõ†Ô∏è</div>
            <h3>M√ºhendis</h3>
        </div>
    </div>

    <!-- App Interface -->
    <div id="app" class="app-container hidden">
        <header>
            <div class="brand">
                <span>ü¶Å Kaspar</span>
                <span id="conn-dot" class="connection-dot"></span>
            </div>
            <div id="user-info" style="font-size: 0.8rem; opacity: 0.8;">Misafir</div>
        </header>

        <!-- PARENT PANEL -->
        <div id="parent-panel" class="hidden" style="flex:1; padding:20px; overflow-y:auto;">
            <h2 style="color:var(--accent-color);">Geli≈üim Raporu üìä</h2>
            <div style="background:var(--panel-bg); padding:15px; border-radius:10px; margin-bottom:15px;">
                <h4>Son Durum</h4>
                <p>Seviye: <span id="p-level">--</span></p>
                <p>Puan (XP): <span id="p-xp">--</span></p>
                <p>Toplam Oyun: <span id="p-games">--</span></p>
                <p>Galibiyet: <span id="p-wins">--</span></p>
            </div>
            
            <div class="kaspar-bubble" style="margin-bottom: 20px;">
                <span style="font-size: 1.5rem;">ü¶Å</span>
                <div>
                    <strong>Kaspar'ƒ±n Notu:</strong>
                    <div id="p-comment" style="font-style: italic; margin-top: 5px;">Y√ºkleniyor...</div>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="location.reload()">√áƒ±kƒ±≈ü</button>
        </div>

        <!-- GAME AREA (Student/Engineer) -->
        <div id="game-interface" class="game-area">
            <!-- AI Mesajƒ± -->
            <div class="kaspar-bubble">
                <span style="font-size: 1.5rem;">üí≠</span>
                <div id="ai-text">Merhaba! Hadi satran√ß oynayalƒ±m. Beyaz sensin.</div>
            </div>

            <!-- Tahta -->
            <div class="board-container">
                <div id="board" style="width: 100%; height: 100%;"></div>
            </div>

            <!-- Durum -->
            <div id="status" style="font-size: 0.9rem; color: #94a3b8;">Sƒ±ra Beyazda</div>
        </div>

        <div id="controls-bar" class="controls">
            <button class="btn btn-secondary" onclick="app.resetGame()">üîÑ Yeni</button>
            <button class="btn" onclick="app.askHint()">üí° ƒ∞pucu</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            apiKey: "kaspar_sec_eb82b49055236a3a862f42e53e8e8b97",
            apiUrl: "https://kadir-pc.taildc8da7.ts.net/api", // Tailscale Funnel
            passwords: {
                student: "1234",
                engineer: "jarvis",
                parent: "ebeveyn"
            }
        };

        // --- APP LOGIC ---
        class KasparApp {
            constructor() {
                this.game = new Chess();
                this.board = null;
                this.role = null;
                this.isLocked = false; // AI d√º≈ü√ºn√ºrken tahtayƒ± kilitle
                this.isConnected = false;
                
                this.checkConnection();
                setInterval(() => this.checkConnection(), 30000);
            }

            // Baƒülantƒ± Kontrol√º
            async checkConnection() {
                try {
                    const res = await fetch(`${CONFIG.apiUrl}/status`, { timeout: 3000 });
                    this.isConnected = res.ok;
                    document.getElementById('conn-dot').className = `connection-dot ${this.isConnected ? 'online' : ''}`;
                } catch (e) {
                    this.isConnected = false;
                    document.getElementById('conn-dot').className = 'connection-dot';
                    console.log("Baƒülantƒ± hatasƒ±:", e);
                }
            }

            // Giri≈ü
            login(role) {
                const pin = prompt(`${role === 'student' ? '√ñƒürenci' : (role === 'parent' ? 'Ebeveyn' : 'M√ºhendis')} ≈ûifresi:`);
                if (pin === CONFIG.passwords[role]) {
                    this.role = role;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                    document.getElementById('user-info').innerText = role.toUpperCase();
                    
                    if (role === 'parent') {
                        document.getElementById('game-interface').classList.add('hidden');
                        document.getElementById('controls-bar').classList.add('hidden');
                        document.getElementById('parent-panel').classList.remove('hidden');
                        this.loadParentStats();
                    } else {
                        // Oyun modunu ba≈ülat
                        setTimeout(() => this.initBoard(), 100);
                    }
                } else {
                    alert("Hatalƒ± ≈üifre!");
                }
            }

            async loadParentStats() {
                try {
                    const res = await fetch(`${CONFIG.apiUrl}/stats`, { 
                        headers: { 'X-Kaspar-Key': CONFIG.apiKey } 
                    });
                    const data = await res.json();
                    
                    document.getElementById('p-level').innerText = data.level;
                    document.getElementById('p-xp').innerText = data.xp;
                    document.getElementById('p-games').innerText = data.total_games;
                    document.getElementById('p-wins').innerText = data.wins;
                    document.getElementById('p-comment').innerText = data.kaspar_comment || "Hen√ºz veri yok.";
                } catch(e) {
                    console.error(e);
                    document.getElementById('p-level').innerText = "Hata";
                }
            }

            // Tahta Kurulumu
            initBoard() {
                const boardEl = document.getElementById('board');
                
                // CSS ile boyutlandƒ±rmayƒ± garantiye alalƒ±m
                // Chessboardjs bazen display:none i√ßindeyken boyut hesaplayamaz
                // Bu y√ºzden g√∂r√ºn√ºr olduƒüundan emin olmalƒ±yƒ±z.
                
                if (this.board) {
                    this.board.destroy(); // Varsa eskisi sil
                }

                this.board = Chessboard('board', {
                    draggable: true,
                    position: 'start',
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                    onDragStart: (source, piece) => this.onDragStart(source, piece),
                    onDrop: (source, target) => this.onDrop(source, target),
                    onSnapEnd: () => this.board.position(this.game.fen())
                });

                // Resize handler (Responsive)
                setTimeout(() => this.board.resize(), 200); // ƒ∞lk render i√ßin gecikmeli resize
                window.addEventListener('resize', () => this.board.resize());
                
                // Mobil kaydƒ±rmayƒ± engelle (Touch hack)
                if(boardEl) {
                   boardEl.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
                }
            }

            onDragStart(source, piece) {
                // Oyun bitti mi veya AI d√º≈ü√ºn√ºyor mu?
                if (this.game.game_over() || this.isLocked) return false;
                
                // Sadece kendi rengini oynat (√ñƒürenci = Beyaz)
                if (this.game.turn() === 'b' && this.role === 'student') return false;
            }

            onDrop(source, target) {
                const move = this.game.move({
                    from: source,
                    to: target,
                    promotion: 'q' // Otomatik vezir
                });

                if (move === null) return 'snapback';

                this.updateStatus();
                
                // Hamle ba≈üarƒ±lƒ±, sƒ±ra AI'da
                if (!this.game.game_over()) {
                    this.makeAiMove();
                } else {
                    this.handleGameOver();
                }
            }

            async makeAiMove() {
                this.isLocked = true;
                this.setAiThinking(true);

                try {
                    const response = await fetch(`${CONFIG.apiUrl}/move`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Kaspar-Key': CONFIG.apiKey
                        },
                        body: JSON.stringify({ 
                            fen: this.game.fen(), 
                            role: this.role 
                        })
                    });

                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        // AI Hamlesi
                        this.game.move(data.best_move, { sloppy: true });
                        this.board.position(this.game.fen());
                        
                        // Yorumu g√∂ster
                        document.getElementById('ai-text').innerHTML = data.comment;
                    } else {
                        throw new Error(data.message);
                    }

                } catch (e) {
                    console.error("AI Hatasƒ±:", e);
                    document.getElementById('ai-text').innerText = "Hmm, baƒülantƒ±mda bir sorun var. Tekrar dener misin?";
                } finally {
                    this.isLocked = false;
                    this.setAiThinking(false);
                    this.updateStatus();
                    
                    if (this.game.game_over()) this.handleGameOver();
                }
            }

            async askHint() {
                if (this.isLocked) return;
                
                document.getElementById('ai-text').innerText = "Sana bir ipucu bakƒ±yorum...";
                
                try {
                    const res = await fetch(`${CONFIG.apiUrl}/hint`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Kaspar-Key': CONFIG.apiKey },
                        body: JSON.stringify({ fen: this.game.fen() })
                    });
                    const data = await res.json();
                    document.getElementById('ai-text').innerText = "üí° " + data.hint;
                } catch (e) {
                    document.getElementById('ai-text').innerText = "ƒ∞pucu alamadƒ±m.";
                }
            }

            updateStatus() {
                let status = '';
                const moveColor = this.game.turn() === 'w' ? 'Beyaz' : 'Siyah';

                if (this.game.in_check()) status = `${moveColor} ≈ûAH!`;
                else status = `Sƒ±ra ${moveColor}da`;

                document.getElementById('status').innerText = status;
            }

            handleGameOver() {
                let result = 'draw';
                if (this.game.in_checkmate()) {
                    result = this.game.turn() === 'w' ? 'loss' : 'win'; // Kim mat oldu?
                }
                
                const msg = result === 'win' ? "Tebrikler! Kazandƒ±n! üèÜ" : (result === 'loss' ? "Mat oldun! Bir dahakine..." : "Berabere!");
                document.getElementById('ai-text').innerHTML = `<b>${msg}</b>`;
                
                // Sonucu kaydet
                fetch(`${CONFIG.apiUrl}/game/end`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Kaspar-Key': CONFIG.apiKey },
                    body: JSON.stringify({ result: result, moves: this.game.history().length })
                });
            }

            resetGame() {
                this.game.reset();
                this.board.start();
                this.isLocked = false;
                this.updateStatus();
                document.getElementById('ai-text').innerText = "Yeni oyun! Ba≈üarƒ±lar.";
            }

            setAiThinking(thinking) {
                const bubble = document.querySelector('.kaspar-bubble');
                if (thinking) {
                    bubble.classList.add('thinking');
                    document.getElementById('ai-text').innerText = "Kaspar d√º≈ü√ºn√ºyor...";
                } else {
                    bubble.classList.remove('thinking');
                }
            }
        }

        // Ba≈ülat
        window.app = new KasparApp();

    </script>
</body>
</html>
