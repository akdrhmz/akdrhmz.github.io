<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaspar SatranÃ§ Akademisi</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --text: #f8fafc; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .app { display: flex; flex-direction: column; height: 100vh; max-width: 600px; margin: 0 auto; }
        
        /* Modal & Auth */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card { background: var(--panel); padding: 20px; margin: 10px; border-radius: 15px; width: 280px; text-align: center; border: 2px solid transparent; cursor: pointer; }
        .card:hover { border-color: var(--accent); }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #020617; color: white; text-align: center; font-size: 1rem; }
        
        /* UI Components */
        .btn { background: var(--accent); color: #000; padding: 12px; border: none; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 5px; }
        .btn-green { background: #22c55e; color: white; }
        header { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; }
        
        /* Game */
        .game-area { flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 15px; justify-content: center; }
        .bubble { background: var(--panel); padding: 15px; border-radius: 12px; border-left: 4px solid var(--accent); min-height: 50px; display: flex; align-items: center; gap: 10px; }
        #board { width: 100%; aspect-ratio: 1; border: 3px solid #334155; border-radius: 8px; }
        
        /* Parent */
        .list-item { background: var(--panel); padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; cursor: pointer; }
        .code-display { font-size: 2rem; letter-spacing: 5px; color: var(--accent); font-weight: bold; margin: 20px 0; }
    </style>
</head>
<body>

    <!-- GÄ°RÄ°Å -->
    <div id="screen-home" class="modal">
        <h1 style="color:var(--accent);">ğŸ¦ Kaspar</h1>
        <div class="card" onclick="app.showAuth('student')"><h1>ğŸ“</h1><h3>Ã–ÄŸrenci</h3></div>
        <div class="card" onclick="app.showAuth('parent')"><h1>ğŸ </h1><h3>Ebeveyn</h3></div>
    </div>

    <!-- AUTH -->
    <div id="screen-auth" class="modal hidden">
        <h2 id="auth-title">GiriÅŸ</h2>
        <div style="width:80%;">
            <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±">
            <input type="password" id="password" placeholder="Åifre">
            <button class="btn" onclick="app.login()">GiriÅŸ Yap</button>
            <button class="btn btn-green" id="btn-reg" onclick="app.register()">Yeni KayÄ±t OluÅŸtur</button>
            <br><br>
            <button onclick="location.reload()" style="background:none; border:none; color:#666;">â† Geri DÃ¶n</button>
        </div>
    </div>

    <!-- Ã–ÄRENCÄ° PANELÄ° -->
    <div id="screen-game" class="app hidden">
        <header>
            <span id="game-user" style="font-weight:bold;">Ã–ÄŸrenci</span>
            <button onclick="app.showPairingCode()" style="background:#334155; color:white; border:none; padding:5px 10px; border-radius:15px;">ğŸ”— Velimi BaÄŸla</button>
        </header>
        <div class="game-area">
            <div class="bubble"><span style="font-size:1.5rem;">ğŸ¦</span><div id="ai-text">Merhaba!</div></div>
            <div id="board"></div>
            <div id="status" style="text-align:center; color:#888;">SÄ±ra Beyazda</div>
        </div>
        <div style="padding:15px; background:var(--panel); display:flex; gap:10px;">
            <button class="btn" style="background:#475569; color:white;" onclick="app.resetGame()">Yeni Oyun</button>
            <button class="btn btn-green" onclick="app.askHint()">Ä°pucu</button>
            <button class="btn" style="background:#ef4444; color:white;" onclick="location.reload()">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
    </div>

    <!-- PAIRING CODE MODAL -->
    <div id="modal-code" class="modal hidden">
        <div class="card" style="cursor:default;">
            <h3>Velini BaÄŸla</h3>
            <p>Bu kodu veline ver:</p>
            <div class="code-display" id="pairing-code">...</div>
            <p style="font-size:0.8rem; color:#888;">Ebeveyn panelinden "Ã–ÄŸrenci Ekle" diyerek bu kodu girmeli.</p>
            <button class="btn" onclick="document.getElementById('modal-code').classList.add('hidden')">Tamam</button>
        </div>
    </div>

    <!-- EBEVEYN PANELÄ° -->
    <div id="screen-parent" class="app hidden">
        <header>
            <span>ğŸ“Š Veli Paneli</span>
            <button onclick="location.reload()" style="background:none; border:none; color:white;">Ã‡Ä±kÄ±ÅŸ</button>
        </header>
        <div style="padding:20px; overflow-y:auto; flex:1;">
            <div id="student-list"></div>
            <button class="btn btn-green" onclick="app.showAddStudent()">â• Ã–ÄŸrenci Ekle</button>
        </div>
    </div>

    <!-- ADD STUDENT MODAL -->
    <div id="modal-add-student" class="modal hidden">
        <div class="card" style="cursor:default;">
            <h3>Ã–ÄŸrenci Ekle</h3>
            <input type="text" id="link-code" placeholder="KASPAR-123">
            <button class="btn btn-green" onclick="app.linkStudent()">Ekle</button>
            <button class="btn" style="background:#444; color:white;" onclick="document.getElementById('modal-add-student').classList.add('hidden')">Ä°ptal</button>
        </div>
    </div>
    
    <!-- REPORT MODAL -->
    <div id="modal-report" class="modal hidden">
        <div class="card" style="width:90%; max-width:400px; cursor:default; text-align:left;">
            <h3 id="rep-name" style="color:var(--accent);">Rapor</h3>
            <div id="rep-content" style="line-height:1.6;"></div>
            <button class="btn" onclick="document.getElementById('modal-report').classList.add('hidden')">Kapat</button>
        </div>
    </div>

    <script>
        const API_URL = "https://kadir-pc.taildc8da7.ts.net/api";
        const API_KEY = "kaspar_sec_eb82b49055236a3a862f42e53e8e8b97";

        class App {
            constructor() {
                this.user = null;
                this.role = null;
                this.game = new Chess();
                this.board = null;
            }

            // --- AUTH ---
            showAuth(role) {
                this.role = role;
                document.getElementById('screen-home').classList.add('hidden');
                document.getElementById('screen-auth').classList.remove('hidden');
                if(role === 'parent') document.getElementById('btn-reg').classList.add('hidden');
                else document.getElementById('btn-reg').classList.remove('hidden');
            }

            async login() {
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                const res = await this.post('/auth/login', { username: u, password: p });
                
                if (res.status === 'success') {
                    this.user = res;
                    this.role = res.role; // DB'den gelen rolÃ¼ kullan
                    document.getElementById('screen-auth').classList.add('hidden');
                    
                    if (this.role === 'student') this.initGame();
                    else this.initParent();
                } else alert(res.message);
            }

            async register() {
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                const res = await this.post('/auth/register', { username: u, password: p, role: 'student' });
                alert(res.message);
            }

            // --- STUDENT ---
            initGame() {
                document.getElementById('screen-game').classList.remove('hidden');
                document.getElementById('game-user').innerText = this.user.username;
                setTimeout(() => this.initBoard(), 200);
            }

            async showPairingCode() {
                const res = await this.post('/auth/code/generate', { user_id: this.user.user_id });
                document.getElementById('pairing-code').innerText = res.code;
                document.getElementById('modal-code').classList.remove('hidden');
            }
            
            initBoard() {
                if(this.board) this.board.destroy();
                this.board = Chessboard('board', {
                    draggable: true,
                    position: 'start',
                    onDrop: (s, t) => {
                        const m = this.game.move({ from: s, to: t, promotion: 'q' });
                        if (!m) return 'snapback';
                        this.updateStatus();
                        if (!this.game.game_over()) this.makeAiMove();
                        else this.endGame();
                    }
                });
                document.getElementById('board').addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
                window.addEventListener('resize', () => this.board.resize());
            }

            async makeAiMove() {
                document.getElementById('ai-text').innerText = "DÃ¼ÅŸÃ¼nÃ¼yorum...";
                const res = await this.post('/move', { fen: this.game.fen(), user_id: this.user.user_id });
                if (res.status === 'success') {
                    this.game.move(res.best_move, { sloppy: true });
                    this.board.position(this.game.fen());
                    document.getElementById('ai-text').innerText = res.comment;
                    this.updateStatus();
                    if(this.game.game_over()) this.endGame();
                }
            }
            
            async askHint() {
                const res = await this.post('/hint', { fen: this.game.fen() });
                if(res.status==='success') alert("Ä°pucu: " + res.hint);
            }
            
            async endGame() {
                let res = 'draw';
                if(this.game.in_checkmate()) res = this.game.turn() === 'w' ? 'loss' : 'win';
                await this.post('/game/end', { user_id: this.user.user_id, result: res, moves: this.game.history().length });
                document.getElementById('ai-text').innerHTML = `<b>OYUN BÄ°TTÄ°!</b>`;
            }

            updateStatus() {
                let s = this.game.turn() === 'w' ? "SÄ±ra Beyazda" : "SÄ±ra Siyahda";
                if (this.game.in_check()) s += " (ÅAH!)";
                document.getElementById('status').innerText = s;
            }
            
            resetGame() {
                this.game.reset();
                this.board.start();
                this.updateStatus();
                document.getElementById('ai-text').innerText = "Yeni oyun!";
            }

            // --- PARENT ---
            async initParent() {
                document.getElementById('screen-parent').classList.remove('hidden');
                this.loadMyStudents();
            }

            async loadMyStudents() {
                const res = await this.post('/parent/my_students', { parent_id: this.user.user_id });
                const list = document.getElementById('student-list');
                list.innerHTML = '';
                
                if (res.students && res.students.length > 0) {
                    res.students.forEach(s => {
                        const d = document.createElement('div');
                        d.className = 'list-item';
                        d.innerHTML = `<span>ğŸ“ ${s.username}</span><span>Lvl ${s.current_level}</span>`;
                        d.onclick = () => this.showReport(s.id);
                        list.appendChild(d);
                    });
                } else {
                    list.innerHTML = '<div style="text-align:center; color:#888;">HenÃ¼z ekli Ã¶ÄŸrenci yok.<br>Ã–ÄŸrenci ekranÄ±ndan "Velimi BaÄŸla" diyerek kod almalÄ±sÄ±nÄ±z.</div>';
                }
            }

            showAddStudent() {
                document.getElementById('modal-add-student').classList.remove('hidden');
                document.getElementById('link-code').value = '';
                document.getElementById('link-code').focus();
            }

            async linkStudent() {
                const code = document.getElementById('link-code').value;
                const res = await this.post('/auth/code/claim', { parent_id: this.user.user_id, code: code });
                alert(res.message);
                if (res.status === 'success') {
                    document.getElementById('modal-add-student').classList.add('hidden');
                    this.loadMyStudents();
                }
            }

            async showReport(id) {
                document.getElementById('modal-report').classList.remove('hidden');
                document.getElementById('rep-content').innerHTML = 'YÃ¼kleniyor...';
                const res = await this.post('/parent/report', { student_id: id });
                document.getElementById('rep-name').innerText = res.username + " Raporu";
                document.getElementById('rep-content').innerHTML = `
                    <p><b>Seviye:</b> ${res.level}</p>
                    <p><b>Toplam Oyun:</b> ${res.total_games}</p>
                    <p><b>Galibiyet:</b> ${res.wins}</p>
                    <hr style="border-color:#444;">
                    <p><i>${res.kaspar_comment}</i></p>
                `;
            }

            // --- API ---
            async post(ep, data={}) {
                try {
                    const r = await fetch(API_URL + ep, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-Kaspar-Key': API_KEY },
                        body: JSON.stringify(data)
                    });
                    return await r.json();
                } catch(e) { console.error(e); return {status:'error', message:'BaÄŸlantÄ± hatasÄ±'}; }
            }
        }
        window.app = new App();
    </script>
</body>
</html>
