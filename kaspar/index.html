<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaspar SatranÃ§ Akademisi</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --accent: #38bdf8; --text: #f8fafc; --green: #22c55e; --red: #ef4444; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .app { display: flex; flex-direction: column; height: 100vh; max-width: 600px; margin: 0 auto; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card { background: var(--panel); padding: 20px; margin: 10px; border-radius: 15px; width: 280px; text-align: center; border: 2px solid transparent; cursor: pointer; }
        .card:hover { border-color: var(--accent); }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #020617; color: white; text-align: center; font-size: 1rem; }
        
        .btn { background: var(--accent); color: #000; padding: 12px; border: none; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; margin-top: 5px; }
        .btn-green { background: var(--green); color: white; }
        .btn-red { background: var(--red); color: white; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; width: auto; }
        
        header { padding: 15px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; }
        .game-area { flex: 1; display: flex; flex-direction: column; padding: 10px; gap: 15px; justify-content: center; }
        .bubble { background: var(--panel); padding: 15px; border-radius: 12px; border-left: 4px solid var(--accent); min-height: 50px; display: flex; align-items: center; gap: 10px; }
        #board { width: 100%; aspect-ratio: 1; border: 3px solid #334155; border-radius: 8px; }
        .controls { padding: 15px; display: flex; gap: 10px; background: var(--panel); }
        
        .list-container { width: 100%; padding: 20px; overflow-y: auto; flex: 1; }
        .list-item { background: var(--panel); padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        .code-display { font-size: 2rem; letter-spacing: 5px; color: var(--accent); font-weight: bold; margin: 20px 0; }
        
        /* Admin Table */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: var(--accent); border-bottom: 1px solid #444; padding: 5px; }
        td { padding: 8px 5px; border-bottom: 1px solid #333; }
        .status-badge { padding: 3px 8px; border-radius: 10px; font-size: 0.7rem; }
        .approved { background: rgba(34, 197, 94, 0.2); color: var(--green); }
        .pending { background: rgba(239, 68, 68, 0.2); color: var(--red); }
    </style>
</head>
<body>

    <!-- 1. GÄ°RÄ°Å -->
    <div id="screen-home" class="modal">
        <h1 style="color:var(--accent);">ğŸ¦ Kaspar</h1>
        <div class="card" onclick="app.showAuth('student')"><h1>ğŸ“</h1><h3>Ã–ÄŸrenci</h3></div>
        <div class="card" onclick="app.showAuth('parent')"><h1>ğŸ </h1><h3>Ebeveyn</h3></div>
        <div class="card" onclick="app.showAuth('engineer')"><h1>ğŸ› ï¸</h1><h3>MÃ¼hendis</h3></div>
    </div>

    <!-- 2. AUTH -->
    <div id="screen-auth" class="modal hidden">
        <h2 id="auth-title">GiriÅŸ</h2>
        <div style="width:80%;">
            <input type="text" id="username" placeholder="KullanÄ±cÄ± AdÄ±">
            <input type="password" id="password" placeholder="Åifre">
            <button class="btn" onclick="app.login()">GiriÅŸ Yap</button>
            <button class="btn btn-green" id="btn-reg" onclick="app.register()">Yeni KayÄ±t</button>
            <br>
            <button class="btn" style="background:none; color:#888; font-size:0.8rem;" onclick="app.showResetPassword()">Åifremi Unuttum</button>
            <br><br>
            <button onclick="location.reload()" style="background:none; border:none; color:#666;">â† Geri</button>
        </div>
    </div>

    <!-- 3. OYUN -->
    <div id="screen-game" class="app hidden">
        <header>
            <span style="font-weight:bold; color:var(--accent);">ğŸ¦ Arena</span>
            <div>
                <span id="game-username" style="font-size:0.9rem; margin-right:10px;">Misafir</span>
                <button onclick="app.showPairingCode()" style="background:#334155; color:white; border:none; padding:5px 10px; border-radius:15px;">ğŸ”— BaÄŸla</button>
            </div>
        </header>
        <div class="game-area">
            <div class="bubble"><span style="font-size:1.5rem;">ğŸ¦</span><div id="ai-text">Merhaba!</div></div>
            <div style="width:100%; aspect-ratio:1;"><div id="board"></div></div>
            <div id="status" style="text-align:center; color:#888;">SÄ±ra Beyazda</div>
        </div>
        <div class="controls">
            <button class="btn" style="background:#475569; color:white;" onclick="app.resetGame()">Yeni</button>
            <button class="btn btn-green" onclick="app.askHint()">Ä°pucu</button>
            <button class="btn btn-red" onclick="location.reload()">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
    </div>

    <!-- 4. EBEVEYN -->
    <div id="screen-parent" class="app hidden">
        <header>
            <span>ğŸ“Š Veli Paneli</span>
            <button onclick="location.reload()" style="background:none; border:none; color:white;">Ã‡Ä±kÄ±ÅŸ</button>
        </header>
        <div class="list-container" id="student-list"></div>
        <div style="padding:20px;"><button class="btn btn-green" onclick="app.showAddStudent()">â• Ã–ÄŸrenci Ekle</button></div>
    </div>

    <!-- 5. ADMIN -->
    <div id="screen-admin" class="app hidden">
        <header>
            <span style="color:var(--red);">ğŸ› ï¸ YÃ¶netim</span>
            <button onclick="location.reload()" style="background:none; border:none; color:white;">Ã‡Ä±kÄ±ÅŸ</button>
        </header>
        <div class="list-container">
            <div id="admin-user-list"></div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-code" class="modal hidden">
        <div class="card" style="cursor:default;">
            <h3>Veli BaÄŸlama Kodu</h3>
            <div class="code-display" id="pairing-code">...</div>
            <button class="btn" onclick="document.getElementById('modal-code').classList.add('hidden')">Tamam</button>
        </div>
    </div>

    <div id="modal-add-student" class="modal hidden">
        <div class="card" style="cursor:default;">
            <h3>Ã–ÄŸrenci Ekle</h3>
            <input type="text" id="link-code" placeholder="KOD">
            <button class="btn btn-green" onclick="app.linkStudent()">Ekle</button>
            <button class="btn" onclick="document.getElementById('modal-add-student').classList.add('hidden')">Ä°ptal</button>
        </div>
    </div>
    
    <div id="modal-report" class="modal hidden">
        <div class="card" style="width:90%; max-width:400px; cursor:default; text-align:left;">
            <h3 id="rep-name" style="color:var(--accent);">Rapor</h3>
            <div id="rep-content" style="line-height:1.6;"></div>
            <hr style="border-color:#444; margin:15px 0;">
            <button class="btn" onclick="app.showResetPassword(currentReportId)">Åifre SÄ±fÄ±rla</button>
            <button class="btn btn-red" onclick="document.getElementById('modal-report').classList.add('hidden')">Kapat</button>
        </div>
    </div>

    <div id="modal-reset-pw" class="modal hidden">
        <div class="card" style="cursor:default;">
            <h3>Åifre SÄ±fÄ±rla</h3>
            <input type="text" id="reset-username" disabled style="opacity:0.5;">
            <input type="password" id="new-password" placeholder="Yeni Åifre">
            <button class="btn btn-green" onclick="app.doResetPassword()">GÃ¼ncelle</button>
            <button class="btn" onclick="document.getElementById('modal-reset-pw').classList.add('hidden')">Ä°ptal</button>
        </div>
    </div>

    <script>
        const API_URL = "https://kadir-pc.taildc8da7.ts.net/api";
        const API_KEY = "kaspar_sec_eb82b49055236a3a862f42e53e8e8b97";
        let currentReportId = null;

        class App {
            constructor() {
                this.user = null; this.role = null; this.game = new Chess(); this.board = null;
            }

            showAuth(role) {
                this.role = role;
                document.getElementById('screen-home').classList.add('hidden');
                document.getElementById('screen-auth').classList.remove('hidden');
                document.getElementById('auth-title').innerText = role === 'engineer' ? 'MÃ¼hendis GiriÅŸi' : 'GiriÅŸ Yap';
                if(role === 'engineer') document.getElementById('btn-reg').classList.add('hidden');
                else document.getElementById('btn-reg').classList.remove('hidden');
            }

            async login() {
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                if(!u || !p) return alert("Bilgileri girin.");

                // Backdoor for Engineer Setup
                if(this.role === 'engineer' && u === 'jarvis' && p === 'master') {
                    this.user = { user_id: 0, username: 'Jarvis', role: 'engineer' };
                    this.initAdmin(); return;
                }

                const res = await this.post('/auth/login', { username: u, password: p });
                if (res.status === 'success') {
                    this.user = res;
                    this.role = res.role;
                    document.getElementById('screen-auth').classList.add('hidden');
                    if (this.role === 'student') this.initGame();
                    else if (this.role === 'parent') this.initParent();
                    else if (this.role === 'engineer') this.initAdmin();
                } else alert(res.message);
            }

            async register() {
                const u = document.getElementById('username').value;
                const p = document.getElementById('password').value;
                const res = await this.post('/auth/register', { username: u, password: p, role: this.role });
                
                // BaÅŸarÄ±lÄ± olsa bile pending uyarÄ±sÄ± ver
                if (res.status === 'success') {
                   alert("KayÄ±t baÅŸarÄ±lÄ±! Ancak gÃ¼venlik gereÄŸi YÃ–NETÄ°CÄ° ONAYI gerekmektedir. YÃ¶neticiye haber verildi.");
                   location.reload();
                } else {
                   alert(res.message);
                }
            }

            // --- STUDENT ---
            initGame() {
                document.getElementById('screen-game').classList.remove('hidden');
                document.getElementById('game-username').innerText = this.user.username;
                setTimeout(() => this.initBoard(), 200);
            }
            async showPairingCode() {
                const res = await this.post('/auth/code/generate', { user_id: this.user.user_id });
                document.getElementById('pairing-code').innerText = res.code;
                document.getElementById('modal-code').classList.remove('hidden');
            }
            initBoard() {
                if(this.board) this.board.destroy();
                this.board = Chessboard('board', {
                    draggable: true, position: 'start',
                    onDrop: (s, t) => {
                        const m = this.game.move({ from: s, to: t, promotion: 'q' });
                        if (!m) return 'snapback';
                        this.updateStatus();
                        if (!this.game.game_over()) this.makeAiMove(); else this.endGame();
                    }
                });
                document.getElementById('board').addEventListener('touchmove', e => e.preventDefault(), {passive:false});
                window.addEventListener('resize', () => this.board.resize());
            }
            async makeAiMove() {
                document.getElementById('ai-text').innerText = "DÃ¼ÅŸÃ¼nÃ¼yorum...";
                const res = await this.post('/move', { fen: this.game.fen(), user_id: this.user.user_id });
                if (res.status === 'success') {
                    this.game.move(res.best_move, { sloppy: true });
                    this.board.position(this.game.fen());
                    document.getElementById('ai-text').innerText = res.comment;
                    this.updateStatus();
                    if(this.game.game_over()) this.endGame();
                }
            }
            updateStatus() { document.getElementById('status').innerText = this.game.in_check() ? "ÅAH!" : (this.game.turn() === 'w' ? "SÄ±ra Beyazda" : "SÄ±ra Siyahda"); }
            async endGame() { 
                let r = 'draw'; if(this.game.in_checkmate()) r = this.game.turn() === 'w' ? 'loss' : 'win';
                await this.post('/game/end', { user_id: this.user.user_id, result: r, moves: this.game.history().length });
                document.getElementById('ai-text').innerHTML = `<b>OYUN BÄ°TTÄ°!</b>`;
            }
            resetGame() { this.game.reset(); this.board.start(); this.updateStatus(); document.getElementById('ai-text').innerText = "Yeni Oyun!"; }
            async askHint() { const r = await this.post('/hint', {fen:this.game.fen()}); if(r.status==='success') alert(r.hint); }

            // --- PARENT ---
            async initParent() {
                document.getElementById('screen-parent').classList.remove('hidden');
                this.loadMyStudents();
            }
            async loadMyStudents() {
                const res = await this.post('/parent/my_students', { parent_id: this.user.user_id });
                const list = document.getElementById('student-list');
                list.innerHTML = '';
                if (res.students && res.students.length > 0) {
                    res.students.forEach(s => {
                        const d = document.createElement('div'); d.className = 'list-item';
                        d.innerHTML = `<span>ğŸ“ ${s.username}</span><span>Lvl ${s.current_level}</span>`;
                        d.onclick = () => this.showReport(s.id, s.username);
                        list.appendChild(d);
                    });
                } else list.innerHTML = '<div style="text-align:center; color:#888;">HenÃ¼z ekli Ã¶ÄŸrenci yok.</div>';
            }
            async showReport(id, name) {
                currentReportId = id;
                document.getElementById('modal-report').classList.remove('hidden');
                document.getElementById('rep-content').innerHTML = 'YÃ¼kleniyor...';
                document.getElementById('rep-name').innerText = name;
                const res = await this.post('/parent/report', { student_id: id });
                document.getElementById('rep-content').innerHTML = `<p><b>Oyun:</b> ${res.total_games} | <b>Galibiyet:</b> ${res.wins}</p><div style="background:#334155; padding:10px; margin-top:10px; font-style:italic;">"${res.kaspar_comment}"</div>`;
            }
            showAddStudent() { document.getElementById('modal-add-student').classList.remove('hidden'); }
            async linkStudent() {
                const code = document.getElementById('link-code').value;
                const res = await this.post('/auth/code/claim', { parent_id: this.user.user_id, code: code });
                alert(res.message);
                if (res.status === 'success') { document.getElementById('modal-add-student').classList.add('hidden'); this.loadMyStudents(); }
            }

            // --- ADMIN ---
            async initAdmin() {
                document.getElementById('screen-auth').classList.add('hidden');
                document.getElementById('screen-admin').classList.remove('hidden');
                this.loadAdminData();
            }
            async loadAdminData() {
                const res = await this.post('/admin/users', { role: 'engineer' });
                const list = document.getElementById('admin-user-list');
                let html = '<table><tr><th>User</th><th>Rol</th><th>Durum</th><th>Ä°ÅŸlem</th></tr>';
                res.users.forEach(u => {
                    const status = u.is_approved ? '<span class="status-badge approved">Aktif</span>' : '<span class="status-badge pending">Bekliyor</span>';
                    let actions = `<button class="btn btn-small" onclick="app.showResetPassword(${u.id}, '${u.username}')">ğŸ”‘</button>`;
                    if(!u.is_approved) actions += ` <button class="btn btn-small btn-green" onclick="app.approveUser(${u.id})">âœ…</button>`;
                    actions += ` <button class="btn btn-small btn-red" onclick="app.deleteUser(${u.id})">ğŸ—‘ï¸</button>`;
                    
                    html += `<tr><td>${u.username}</td><td>${u.role}</td><td>${status}</td><td>${actions}</td></tr>`;
                });
                html += '</table>';
                list.innerHTML = html;
            }
            async approveUser(id) { await this.post('/admin/approve', { user_id: id, role: 'engineer' }); this.loadAdminData(); }
            async deleteUser(id) { if(confirm('Silinsin mi?')) { await this.post('/admin/delete', { user_id: id, role: 'engineer' }); this.loadAdminData(); } }

            // --- PASSWORD ---
            showResetPassword(tId=null, tName=null) {
                if(!this.user && !tId) return alert("YÃ¶netici ile iletiÅŸime geÃ§in.");
                currentReportId = tId || this.user.user_id;
                document.getElementById('modal-reset-pw').classList.remove('hidden');
                document.getElementById('reset-username').value = tName || (this.user ? this.user.username : 'KullanÄ±cÄ±');
            }
            async doResetPassword() {
                const newPw = document.getElementById('new-password').value;
                const res = await this.post('/auth/password/reset', { requester_id: this.user.user_id, requester_role: this.user.role, target_user_id: currentReportId, new_password: newPw });
                alert(res.message);
                if(res.status==='success') document.getElementById('modal-reset-pw').classList.add('hidden');
            }

            async post(ep, data={}) {
                try {
                    const r = await fetch(API_URL + ep, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-Kaspar-Key': API_KEY }, body: JSON.stringify(data) });
                    return await r.json();
                } catch(e) { return {status:'error', message:'BaÄŸlantÄ± hatasÄ±'}; }
            }
        }
        window.app = new App();
    </script>
</body>
</html>
