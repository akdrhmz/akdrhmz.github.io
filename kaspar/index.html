<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspar SatranÃ§ Akademisi</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --container-bg: #1e293b;
            --text-color: #f8fafc;
            --primary-blue: #38bdf8;
            --accent-gold: #fbbf24;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --stat-bg: #334155;
            --role-accent: var(--primary-blue);
        }

        body.role-student { --role-accent: var(--accent-gold); }
        body.role-parent { --role-accent: var(--accent-green); }
        body.role-engineer { --role-accent: var(--accent-blue); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .main-layout {
            display: flex;
            gap: 20px;
            align-items: stretch;
            max-width: 1400px;
            width: 95%;
            padding: 20px;
            min-height: 80vh;
        }

        .side-panel {
            flex: 1;
            background: var(--container-bg);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-top: 5px solid var(--role-accent);
        }

        .container {
            flex: 2;
            background: var(--container-bg);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
            border-top: 5px solid var(--role-accent);
        }

        .hidden { display: none !important; }

        .role-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 30px 0; }
        .role-card { background: #334155; padding: 20px; border-radius: 15px; cursor: pointer; transition: 0.3s; border: 2px solid transparent; }
        .role-card:hover { border-color: var(--primary-blue); transform: translateY(-5px); }

        .stat-box { background: var(--stat-bg); padding: 15px; border-radius: 12px; border-bottom: 3px solid var(--role-accent); }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--role-accent); }
        .stat-label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; }

        .widget { background: #334155; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: left; }
        .widget-title { font-size: 0.9rem; font-weight: bold; color: var(--role-accent); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }

        .kaspar-bubble { background: #334155; padding: 15px; border-radius: 15px; border-left: 5px solid var(--role-accent); position: relative; min-height: 60px; }
        .kaspar-bubble::after { content: ''; position: absolute; left: -10px; top: 20px; border-width: 10px 10px 10px 0; border-style: solid; border-color: transparent #334155 transparent transparent; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: var(--container-bg); padding: 30px; border-radius: 20px; border: 3px solid var(--accent-gold); max-width: 400px; text-align: center; }

        #board { width: 450px; margin: 10px auto; border: 5px solid #334155; border-radius: 8px; }
        .btn { background: var(--role-accent); color: #0f172a; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-gold { background: var(--accent-gold); }
        .btn-purple { background: #a855f7; color: white; }
        .btn-link { background: none; color: var(--role-accent); text-decoration: underline; font-size: 0.8rem; cursor: pointer; border: none; margin-top: 10px; }

        .progress-bar-container { background: #334155; border-radius: 10px; height: 10px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--role-accent); width: 0%; transition: width 1s ease-in-out; }
        
        .list-item { background: #334155; margin-bottom: 8px; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid var(--role-accent); }
        
        .terminal { background: #000; color: #0f0; font-family: 'Courier New', Courier, monospace; padding: 15px; border-radius: 10px; text-align: left; height: 200px; overflow-y: auto; font-size: 0.85rem; border: 1px solid #334155; }
        .terminal-line { margin-bottom: 4px; }

        @media (max-width: 900px) { 
            .main-layout { flex-direction: column; align-items: center; } 
            .side-panel { width: 100%; order: 2; }
            .container { width: 100%; order: 1; padding: 1rem; }
            #board { width: 90vw; max-width: 400px; } 
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
</head>
<body>

    <div id="golden-tip-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2 style="color: var(--accent-gold);">ğŸ¦ Kaspar'Ä±n AltÄ±n Ã–ÄŸÃ¼dÃ¼</h2>
            <div id="golden-tip-content" style="margin: 20px 0; font-style: italic;"></div>
            <button class="btn btn-gold" onclick="closeModal('golden-tip-modal')">TeÅŸekkÃ¼rler Kaspar!</button>
        </div>
    </div>

    <div id="login-screen" class="container" style="max-width: 600px;">
        <h1 style="color: var(--primary-blue);">ğŸ¦ Kaspar</h1>
        <p>SatranÃ§ Akademisi - Junior</p>
        <div class="role-selector">
            <div class="role-card" onclick="openLogin('student')"><span>ğŸ“</span><h3>Ã–ÄŸrenci</h3></div>
            <div class="role-card" onclick="openLogin('parent')"><span>ğŸ </span><h3>Ebeveyn</h3></div>
            <div class="role-card" onclick="openLogin('engineer')"><span>ğŸ› ï¸</span><h3>MÃ¼hendis</h3></div>
        </div>
        <div id="auth-panel" class="hidden">
            <h4 id="auth-title">GiriÅŸ Yap</h4>
            <input type="password" id="auth-input" style="background:#0f172a; color:white; padding:10px; border-radius:8px; border:1px solid #475569; text-align:center;">
            <br>
            <button class="btn" onclick="handleLogin()">GiriÅŸ</button>
            <br>
            <button class="btn-link" onclick="forgotPassword()">Åifremi Unuttum</button>
        </div>
    </div>

    <div id="main-layout" class="main-layout hidden">
        <div class="side-panel">
            <div style="text-align:center;"><span style="font-size:3rem;" id="side-icon">ğŸ¦</span><h3 id="side-title">Kaspar Mentor</h3></div>
            <div class="kaspar-bubble"><div id="ai-thought">Merhaba Åampiyon! Hamle sÄ±rasÄ± sende.</div></div>
            
            <div id="student-stats" class="role-specific-ui">
                <h4 style="margin-bottom:10px; color:var(--role-accent);">BaÅŸarÄ±larÄ±n ğŸ†</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="stat-box"><div class="stat-value">850</div><div class="stat-label">PuanÄ±n</div></div>
                    <div class="stat-box"><div class="stat-value">12</div><div class="stat-label">Galibiyet</div></div>
                </div>
            </div>

            <div id="parent-stats" class="role-specific-ui hidden">
                <h4 style="margin-bottom:10px; color:var(--role-accent);">HÄ±zlÄ± BakÄ±ÅŸ ğŸ“ˆ</h4>
                <div class="stat-box" style="margin-bottom:10px;"><div class="stat-value">+%15</div><div class="stat-label">HaftalÄ±k GeliÅŸim</div></div>
                <div class="stat-box"><div class="stat-value">1.2s</div><div class="stat-label">Ort. Hamle SÃ¼resi</div></div>
            </div>

            <div id="engineer-stats" class="role-specific-ui hidden">
                <h4 style="margin-bottom:10px; color:var(--role-accent);">Sistem KaynaklarÄ± âš™ï¸</h4>
                <div class="stat-label">CPU SÄ±caklÄ±k</div>
                <div class="progress-bar-container"><div id="cpu-bar" class="progress-bar" style="width: 45%;"></div></div>
                <div class="stat-label">RAM KullanÄ±mÄ±</div>
                <div class="progress-bar-container"><div id="ram-bar" class="progress-bar" style="width: 62%;"></div></div>
            </div>
        </div>

        <div class="container">
            <div style="position:absolute; top:10px; right:10px; display: flex; gap: 10px; z-index: 10;">
                <button onclick="logout()" style="background:#ef4444; color:white; border:none; border-radius:5px; cursor:pointer; padding:5px 10px;">Ã‡Ä±kÄ±ÅŸ</button>
            </div>

            <div id="student-view" class="role-view">
                <h2 style="color:var(--role-accent); margin-top:0;">ğŸ¦ Kaspar Arena</h2>
                <div id="board"></div>
                <div id="status" style="font-weight: bold; margin: 10px 0;">SÄ±ra Beyazda</div>
                <div style="display:flex; justify-content:center; gap:10px; margin-top:10px;">
                    <button class="btn" onclick="resetBoard()">Yeni Oyun</button>
                    <button class="btn btn-purple" id="ai-move-btn" onclick="makeBestMove()">Kaspar OynasÄ±n</button>
                    <button class="btn-link" onclick="askKaspar()">Ä°pucu Al</button>
                </div>
            </div>

            <div id="parent-view" class="role-view hidden">
                <h2 style="color:var(--role-accent); margin-top:0;">ğŸ  Veli GÃ¶zetim Merkezi</h2>
                <canvas id="progressChart" height="150"></canvas>
            </div>

            <div id="engineer-view" class="role-view hidden">
                <h2 style="color:var(--role-accent); margin-top:0;">ğŸ› ï¸ MÃ¼hendislik & PowerPool</h2>
                <div class="terminal" id="terminal-output"></div>
            </div>
        </div>
    </div>

    <script>
        var currentRole = '';
        var board = null;
        var game = new Chess();
        var progressChart = null;

        // Backend: kadir-pc Ã¼zerinden Tailscale Funnel ile eriÅŸim
        // HTTPS gerekli: GitHub Pages HTTPS, backend de HTTPS olmalÄ±
        const API_URL = 'https://kadir-pc.taildc8da7.ts.net:5000/api';

        function openLogin(role) {
            currentRole = role;
            document.getElementById('auth-panel').classList.remove('hidden');
            document.getElementById('auth-title').innerText = role === 'student' ? 'Ã–ÄŸrenci GiriÅŸi' : (role === 'parent' ? 'Ebeveyn GiriÅŸi' : 'MÃ¼hendis Paneli');
        }

        function handleLogin() {
            var val = document.getElementById('auth-input').value;
            if((currentRole === 'student' && val === '1234') || (currentRole === 'parent' && val === 'ebeveyn') || (currentRole === 'engineer' && val === 'jarvis')) {
                document.body.className = 'role-' + currentRole + ' fade-in';
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-layout').classList.remove('hidden');
                setupPanelFeatures();
                if (currentRole === 'student') setTimeout(initChess, 100);
                else if (currentRole === 'parent') initChart();
            } else { alert('HatalÄ± ÅŸifre!'); }
        }

        function logout() { location.reload(); }

        function setupPanelFeatures() {
            document.querySelectorAll('.role-specific-ui, .role-view').forEach(el => el.classList.add('hidden'));
            if (currentRole === 'student') {
                document.getElementById('student-stats').classList.remove('hidden');
                document.getElementById('student-view').classList.remove('hidden');
            } else if (currentRole === 'parent') {
                document.getElementById('parent-stats').classList.remove('hidden');
                document.getElementById('parent-view').classList.remove('hidden');
            } else if (currentRole === 'engineer') {
                document.getElementById('engineer-stats').classList.remove('hidden');
                document.getElementById('engineer-view').classList.remove('hidden');
                startEngineerPolling();
            }
        }

        function initChess() {
            if (!board) {
                board = Chessboard('board', {
                    draggable: true,
                    position: 'start',
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                    onDrop: function(source, target) {
                        var move = game.move({ from: source, to: target, promotion: 'q' });
                        if (move === null) return 'snapback';
                        updateStatus();
                    }
                });
            }
            updateStatus();
        }

        function updateStatus() {
            var status = game.turn() === 'w' ? 'SÄ±ra Beyazda' : 'SÄ±ra Siyahda';
            if (game.in_checkmate()) status = "MAT! Oyun bitti.";
            document.getElementById('status').innerText = status;
        }

        async function makeBestMove() {
            if (game.game_over()) return;
            document.getElementById('ai-thought').innerText = "Kaspar dÃ¼ÅŸÃ¼nÃ¼yor...";
            
            try {
                const response = await fetch(`${API_URL}/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fen: game.fen(), role: currentRole })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    game.move(data.best_move);
                    board.position(game.fen());
                    updateStatus();
                    document.getElementById('ai-thought').innerHTML = `ğŸ¦ <b>Kaspar:</b> ${data.comment}`;
                }
            } catch (err) {
                document.getElementById('ai-thought').innerText = "Hata: Beyne ulaÅŸÄ±lamadÄ±!";
            }
        }

        async function askKaspar() {
            document.getElementById('ai-thought').innerText = "Kaspar dÃ¼ÅŸÃ¼nÃ¼yor...";
            
            try {
                const response = await fetch(`${API_URL}/hint`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fen: game.fen() })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('ai-thought').innerHTML = `ğŸ’¡ <b>Ä°pucu:</b> ${data.hint}`;
                } else {
                    document.getElementById('ai-thought').innerText = "Kaspar: 'Merkez kareleri kontrol etmeye odaklan ÅŸampiyon!'";
                }
            } catch (err) {
                document.getElementById('ai-thought').innerText = "Kaspar: 'Merkez kareleri kontrol etmeye odaklan ÅŸampiyon!'";
            }
        }

        function resetBoard() {
            game.reset();
            board.start();
            updateStatus();
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        function initChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt', 'Paz'],
                    datasets: [{
                        label: 'Ã‡alÄ±ÅŸma Saati',
                        data: [1, 2, 1.5, 3, 2, 4, 3.5],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true
                    }]
                }
            });
        }

        // MÃ¼hendis Paneli - CanlÄ± PowerPool Durumu
        var engineerPollingInterval = null;
        
        function startEngineerPolling() {
            updatePowerPoolStatus();
            engineerPollingInterval = setInterval(updatePowerPoolStatus, 5000);
        }
        
        async function updatePowerPoolStatus() {
            const terminal = document.getElementById('terminal-output');
            
            try {
                const response = await fetch(`${API_URL}/powerpool`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    let output = '<div class="terminal-line" style="color:#0ff;">âš¡ POWERPOOL STATUS âš¡</div>';
                    output += `<div class="terminal-line">Aktif Batarya: ${data.active}/${data.total}</div>`;
                    output += `<div class="terminal-line">Toplam KullanÄ±m: ${data.total_usage}</div>`;
                    output += '<div class="terminal-line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>';
                    
                    data.batteries.forEach(b => {
                        const icon = b.active ? 'ğŸŸ¢' : 'ğŸ”´';
                        output += `<div class="terminal-line">${icon} ${b.email}</div>`;
                        output += `<div class="terminal-line" style="color:#888;">   KullanÄ±m: ${b.usage} | Hata: ${b.errors}</div>`;
                        output += `<div class="terminal-line" style="color:#888;">   Son: ${b.last_used}</div>`;
                    });
                    
                    output += '<div class="terminal-line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>';
                    output += `<div class="terminal-line" style="color:#0f0;">[${new Date().toLocaleTimeString()}] GÃ¼ncellendi</div>`;
                    
                    terminal.innerHTML = output;
                }
            } catch (err) {
                terminal.innerHTML = `<div class="terminal-line" style="color:#f00;">âŒ Brain API baÄŸlantÄ±sÄ± yok!</div>
                    <div class="terminal-line" style="color:#888;">Endpoint: ${API_URL}/powerpool</div>
                    <div class="terminal-line" style="color:#888;">Hata: ${err.message}</div>`;
            }
        }
        
        // Sayfa kapatÄ±lÄ±rken polling'i durdur
        window.addEventListener('beforeunload', function() {
            if (engineerPollingInterval) clearInterval(engineerPollingInterval);
        });
    </script>
</body>
</html>
