<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaspar SatranÃ§ Akademisi</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --container-bg: #1e293b;
            --text-color: #f8fafc;
            --primary-blue: #38bdf8;
            --accent-gold: #fbbf24;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --stat-bg: #334155;
            --role-accent: var(--primary-blue);
        }

        body.role-student { --role-accent: var(--accent-gold); }
        body.role-parent { --role-accent: var(--accent-green); }
        body.role-engineer { --role-accent: var(--accent-blue); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .pulse { animation: pulse 1.5s infinite; }
        
        * { box-sizing: border-box; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .main-layout {
            display: flex;
            gap: 20px;
            align-items: stretch;
            max-width: 1400px;
            width: 100%;
            padding: 15px;
            margin: 0 auto;
            min-height: 100vh;
        }

        .side-panel {
            flex: 1;
            min-width: 280px;
            max-width: 350px;
            background: var(--container-bg);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            border-top: 5px solid var(--role-accent);
        }

        .container {
            flex: 2;
            background: var(--container-bg);
            padding: 1.5rem;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
            border-top: 5px solid var(--role-accent);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .hidden { display: none !important; }

        .role-selector { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 30px 0; width: 100%; max-width: 500px; }
        .role-card { background: #334155; padding: 20px; border-radius: 15px; cursor: pointer; transition: 0.3s; border: 2px solid transparent; }
        .role-card:hover { border-color: var(--primary-blue); transform: translateY(-5px); }
        .role-card span { font-size: 2rem; }

        .stat-box { background: var(--stat-bg); padding: 15px; border-radius: 12px; border-bottom: 3px solid var(--role-accent); }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--role-accent); }
        .stat-label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; }

        .widget { background: #334155; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: left; }
        .widget-title { font-size: 0.9rem; font-weight: bold; color: var(--role-accent); margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }

        .kaspar-bubble { background: #334155; padding: 15px; border-radius: 15px; border-left: 5px solid var(--role-accent); position: relative; min-height: 60px; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: var(--container-bg); padding: 30px; border-radius: 20px; border: 3px solid var(--accent-gold); max-width: 400px; text-align: center; }

        /* SatranÃ§ TahtasÄ± - Tam Responsive */
        .board-wrapper {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1;
            margin: 10px auto;
        }
        
        #board {
            width: 100% !important;
            height: 100% !important;
            border: 5px solid #334155;
            border-radius: 8px;
        }
        
        .btn { background: var(--role-accent); color: #0f172a; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-gold { background: var(--accent-gold); }
        .btn-purple { background: #a855f7; color: white; }
        .btn-link { background: none; color: var(--role-accent); text-decoration: underline; font-size: 0.8rem; cursor: pointer; border: none; padding: 8px; }

        .progress-bar-container { background: #334155; border-radius: 10px; height: 10px; margin: 10px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--role-accent); width: 0%; transition: width 1s ease-in-out; }
        
        .list-item { background: #334155; margin-bottom: 8px; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid var(--role-accent); }
        
        .terminal { background: #000; color: #0f0; font-family: 'Courier New', Courier, monospace; padding: 15px; border-radius: 10px; text-align: left; height: 250px; overflow-y: auto; font-size: 0.8rem; border: 1px solid #334155; width: 100%; }
        .terminal-line { margin-bottom: 4px; word-break: break-all; }

        .button-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; }

        .connection-status { 
            position: fixed; 
            bottom: 10px; 
            right: 10px; 
            padding: 8px 15px; 
            border-radius: 20px; 
            font-size: 0.75rem;
            z-index: 100;
        }
        .status-online { background: #22c55e; color: white; }
        .status-offline { background: #ef4444; color: white; }

        /* Mobil Responsive */
        @media (max-width: 900px) { 
            .main-layout { 
                flex-direction: column; 
                padding: 10px;
                gap: 15px;
            } 
            .side-panel { 
                width: 100%; 
                max-width: 100%;
                order: 2;
                padding: 15px;
            }
            .container { 
                width: 100%; 
                order: 1; 
                padding: 1rem;
            }
            .board-wrapper {
                max-width: 100%;
                width: calc(100vw - 60px);
            }
            .role-selector {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            .role-card {
                display: flex;
                align-items: center;
                gap: 15px;
                padding: 15px;
            }
            .role-card span { font-size: 1.5rem; }
            .button-group {
                flex-direction: column;
                width: 100%;
            }
            .button-group .btn {
                width: 100%;
            }
        }
        
        @media (max-width: 400px) {
            .stat-value { font-size: 1.2rem; }
            .terminal { height: 180px; font-size: 0.7rem; }
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
</head>
<body>

    <!-- BaÄŸlantÄ± Durumu -->
    <div id="connection-status" class="connection-status status-offline">ğŸ”´ BaÄŸlanÄ±yor...</div>

    <div id="golden-tip-modal" class="modal-overlay hidden">
        <div class="modal">
            <h2 style="color: var(--accent-gold);">ğŸ¦ Kaspar'Ä±n AltÄ±n Ã–ÄŸÃ¼dÃ¼</h2>
            <div id="golden-tip-content" style="margin: 20px 0; font-style: italic;"></div>
            <button class="btn btn-gold" onclick="closeModal('golden-tip-modal')">TeÅŸekkÃ¼rler Kaspar!</button>
        </div>
    </div>

    <div id="login-screen" class="container" style="max-width: 600px; margin: 20px auto;">
        <h1 style="color: var(--primary-blue);">ğŸ¦ Kaspar</h1>
        <p>SatranÃ§ Akademisi - Junior</p>
        <div class="role-selector">
            <div class="role-card" onclick="openLogin('student')"><span>ğŸ“</span><h3>Ã–ÄŸrenci</h3></div>
            <div class="role-card" onclick="openLogin('parent')"><span>ğŸ </span><h3>Ebeveyn</h3></div>
            <div class="role-card" onclick="openLogin('engineer')"><span>ğŸ› ï¸</span><h3>MÃ¼hendis</h3></div>
        </div>
        <div id="auth-panel" class="hidden">
            <h4 id="auth-title">GiriÅŸ Yap</h4>
            <input type="password" id="auth-input" placeholder="Åifre" style="background:#0f172a; color:white; padding:12px; border-radius:8px; border:1px solid #475569; text-align:center; width: 200px; font-size: 1rem;">
            <br><br>
            <button class="btn" onclick="handleLogin()">GiriÅŸ</button>
            <br>
            <button class="btn-link" onclick="forgotPassword()">Åifremi Unuttum</button>
        </div>
    </div>

    <div id="main-layout" class="main-layout hidden">
        <div class="side-panel">
            <div style="text-align:center;"><span style="font-size:3rem;" id="side-icon">ğŸ¦</span><h3 id="side-title">Kaspar Mentor</h3></div>
            <div class="kaspar-bubble"><div id="ai-thought">Merhaba Åampiyon! Hamle sÄ±rasÄ± sende.</div></div>
            
            <div id="student-stats" class="role-specific-ui">
                <h4 style="margin-bottom:10px; color:var(--role-accent);">BaÅŸarÄ±larÄ±n ğŸ†</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="stat-box"><div class="stat-value" id="stat-score">--</div><div class="stat-label">PuanÄ±n</div></div>
                    <div class="stat-box"><div class="stat-value" id="stat-wins">--</div><div class="stat-label">Galibiyet</div></div>
                    <div class="stat-box"><div class="stat-value" id="stat-games">--</div><div class="stat-label">Toplam Oyun</div></div>
                    <div class="stat-box"><div class="stat-value" id="stat-streak">--</div><div class="stat-label">Seri</div></div>
                </div>
            </div>

            <div id="parent-stats" class="role-specific-ui hidden">
                <h4 style="margin-bottom:10px; color:var(--role-accent);">HÄ±zlÄ± BakÄ±ÅŸ ğŸ“ˆ</h4>
                <div class="stat-box" style="margin-bottom:10px;"><div class="stat-value" id="parent-weekly-progress">--</div><div class="stat-label">HaftalÄ±k GeliÅŸim</div></div>
                <div class="stat-box" style="margin-bottom:10px;"><div class="stat-value" id="parent-avg-time">--</div><div class="stat-label">Ort. Hamle SÃ¼resi</div></div>
                <div class="stat-box"><div class="stat-value" id="parent-accuracy">--</div><div class="stat-label">DoÄŸruluk OranÄ±</div></div>
            </div>

            <div id="engineer-stats" class="role-specific-ui hidden">
                <h4 style="margin-bottom:10px; color:var(--role-accent);">Sistem KaynaklarÄ± âš™ï¸</h4>
                <div class="stat-label">CPU KullanÄ±mÄ±: <span id="cpu-value">--</span></div>
                <div class="progress-bar-container"><div id="cpu-bar" class="progress-bar" style="width: 0%;"></div></div>
                <div class="stat-label">RAM KullanÄ±mÄ±: <span id="ram-value">--</span></div>
                <div class="progress-bar-container"><div id="ram-bar" class="progress-bar" style="width: 0%;"></div></div>
                <div class="stat-label">Disk: <span id="disk-value">--</span></div>
                <div class="progress-bar-container"><div id="disk-bar" class="progress-bar" style="width: 0%;"></div></div>
            </div>
        </div>

        <div class="container">
            <div style="position:absolute; top:10px; right:10px; z-index: 10;">
                <button onclick="logout()" style="background:#ef4444; color:white; border:none; border-radius:5px; cursor:pointer; padding:8px 15px; font-size: 0.9rem;">Ã‡Ä±kÄ±ÅŸ</button>
            </div>

            <div id="student-view" class="role-view" style="width: 100%;">
                <h2 style="color:var(--role-accent); margin-top:0;">ğŸ¦ Kaspar Arena</h2>
                <div class="board-wrapper">
                    <div id="board"></div>
                </div>
                <div id="status" style="font-weight: bold; margin: 10px 0;">SÄ±ra Beyazda</div>
                <div class="button-group">
                    <button class="btn" onclick="resetBoard()">Yeni Oyun</button>
                    <button class="btn btn-purple" id="ai-move-btn" onclick="makeBestMove()">Kaspar OynasÄ±n</button>
                    <button class="btn-link" onclick="askKaspar()">ğŸ’¡ Ä°pucu Al</button>
                </div>
            </div>

            <div id="parent-view" class="role-view hidden" style="width: 100%;">
                <h2 style="color:var(--role-accent); margin-top:0;">ğŸ  Veli GÃ¶zetim Merkezi</h2>
                <div style="width: 100%; max-width: 600px; margin: 0 auto;">
                    <canvas id="progressChart" height="200"></canvas>
                </div>
                <div style="margin-top: 20px; text-align: left;">
                    <h4 style="color: var(--role-accent);">Son Aktiviteler</h4>
                    <div id="activity-list"></div>
                </div>
            </div>

            <div id="engineer-view" class="role-view hidden" style="width: 100%;">
                <h2 style="color:var(--role-accent); margin-top:0;">ğŸ› ï¸ MÃ¼hendislik & PowerPool</h2>
                <div class="terminal" id="terminal-output"></div>
                <div class="button-group" style="margin-top: 15px;">
                    <button class="btn" onclick="updatePowerPoolStatus()">ğŸ”„ Yenile</button>
                    <button class="btn btn-purple" onclick="testAPI()">ğŸ§ª API Test</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        var currentRole = '';
        var board = null;
        var game = new Chess();
        var progressChart = null;
        var isConnected = false;

        // GÃœVENLÄ°K ANAHTARI (Faz 2)
        const API_KEY = "kaspar_sec_eb82b49055236a3a862f42e53e8e8b97";

        // API URL - Tailscale Funnel (Port 443 -> 5000)
        const API_URL = 'https://kadir-pc.taildc8da7.ts.net/api';
        
        // Fallback: AynÄ± sunucuda Ã§alÄ±ÅŸÄ±yorsa
        const API_URL_LOCAL = '/brain/api';

        // Helper: Auth Header Ekle
        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'X-Kaspar-Key': API_KEY
            };
        }

        // BaÄŸlantÄ± kontrolÃ¼
        async function checkConnection() {
            const statusEl = document.getElementById('connection-status');
            try {
                // Status endpoint auth istemez ama yine de ekleyelim
                const response = await fetch(`${API_URL}/status`, { timeout: 5000 });
                if (response.ok) {
                    isConnected = true;
                    statusEl.className = 'connection-status status-online';
                    statusEl.innerHTML = 'ğŸŸ¢ Brain Online';
                    return true;
                }
            } catch (e) {
                // Fallback dene
                try {
                    const response2 = await fetch(`${API_URL_LOCAL}/status`, { timeout: 5000 });
                    if (response2.ok) {
                        isConnected = true;
                        statusEl.className = 'connection-status status-online';
                        statusEl.innerHTML = 'ğŸŸ¢ Brain Online (Local)';
                        window.activeAPI = API_URL_LOCAL;
                        return true;
                    }
                } catch (e2) {}
            }
            
            isConnected = false;
            statusEl.className = 'connection-status status-offline';
            statusEl.innerHTML = 'ğŸ”´ Brain Offline';
            return false;
        }

        function getAPIUrl() {
            return window.activeAPI || API_URL;
        }

        // Sayfa yÃ¼klendiÄŸinde baÄŸlantÄ± kontrolÃ¼
        window.addEventListener('load', () => {
            checkConnection();
            setInterval(checkConnection, 30000); // 30 saniyede bir kontrol
        });

        function openLogin(role) {
            currentRole = role;
            document.getElementById('auth-panel').classList.remove('hidden');
            document.getElementById('auth-title').innerText = role === 'student' ? 'Ã–ÄŸrenci GiriÅŸi' : (role === 'parent' ? 'Ebeveyn GiriÅŸi' : 'MÃ¼hendis Paneli');
            document.getElementById('auth-input').focus();
        }

        function handleLogin() {
            var val = document.getElementById('auth-input').value;
            if((currentRole === 'student' && val === '1234') || (currentRole === 'parent' && val === 'ebeveyn') || (currentRole === 'engineer' && val === 'jarvis')) {
                document.body.className = 'role-' + currentRole + ' fade-in';
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-layout').classList.remove('hidden');
                setupPanelFeatures();
                if (currentRole === 'student') setTimeout(initChess, 100);
                else if (currentRole === 'parent') initParentView();
                else if (currentRole === 'engineer') startEngineerPolling();
            } else { alert('HatalÄ± ÅŸifre!'); }
        }
        
        // Enter tuÅŸu ile giriÅŸ
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('auth-panel').classList.contains('hidden')) {
                handleLogin();
            }
        });

        function logout() { location.reload(); }
        
        function forgotPassword() {
            alert('Åifreler:\nâ€¢ Ã–ÄŸrenci: 1234\nâ€¢ Ebeveyn: ebeveyn\nâ€¢ MÃ¼hendis: jarvis');
        }

        function setupPanelFeatures() {
            document.querySelectorAll('.role-specific-ui, .role-view').forEach(el => el.classList.add('hidden'));
            if (currentRole === 'student') {
                document.getElementById('student-stats').classList.remove('hidden');
                document.getElementById('student-view').classList.remove('hidden');
                loadStudentStats();
            } else if (currentRole === 'parent') {
                document.getElementById('parent-stats').classList.remove('hidden');
                document.getElementById('parent-view').classList.remove('hidden');
            } else if (currentRole === 'engineer') {
                document.getElementById('engineer-stats').classList.remove('hidden');
                document.getElementById('engineer-view').classList.remove('hidden');
            }
        }

        // Ã–ÄŸrenci istatistiklerini yÃ¼kle
        async function loadStudentStats() {
            // Åimdilik localStorage'dan oku, ileride API'den Ã§ekilecek
            const stats = JSON.parse(localStorage.getItem('kaspar_stats') || '{"score":850,"wins":0,"games":0,"streak":0}');
            document.getElementById('stat-score').textContent = stats.score;
            document.getElementById('stat-wins').textContent = stats.wins;
            document.getElementById('stat-games').textContent = stats.games;
            document.getElementById('stat-streak').textContent = stats.streak;
        }

        function saveGameResult(won) {
            const stats = JSON.parse(localStorage.getItem('kaspar_stats') || '{"score":850,"wins":0,"games":0,"streak":0}');
            stats.games++;
            if (won) {
                stats.wins++;
                stats.streak++;
                stats.score += 15;
            } else {
                stats.streak = 0;
                stats.score = Math.max(100, stats.score - 10);
            }
            localStorage.setItem('kaspar_stats', JSON.stringify(stats));
            loadStudentStats();
        }

        function onDragStart(source, piece, position, orientation) {
            // Oyun bittiyse taÅŸ oynatma
            if (game.game_over()) return false;
            
            // Sadece kendi rengini oynat (Ã–ÄŸrenci her zaman Beyaz baÅŸlar varsayÄ±mÄ±yla)
            // EÄŸer rol Ã¶ÄŸrenciyse ve sÄ±ra beyazda deÄŸilse (veya tam tersi) engelle
            // Åimdilik basit kural: SÄ±ra kimdeyse o rengi oynatabilsin
            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
                (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
                return false;
            }
        }

        function initChess() {
            const boardWrapper = document.querySelector('.board-wrapper');
            const size = Math.min(boardWrapper.offsetWidth, 500);
            
            if (!board) {
                board = Chessboard('board', {
                    draggable: true,
                    position: 'start',
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                    onDragStart: onDragStart,
                    onDrop: function(source, target) {
                        var move = game.move({ from: source, to: target, promotion: 'q' });
                        if (move === null) return 'snapback';
                        updateStatus();
                        
                        // Oyun bittiyse sonucu kaydet
                        if (game.game_over()) {
                            if (game.in_checkmate()) {
                                saveGameResult(game.turn() === 'b'); // Beyaz kazandÄ±ysa
                            }
                        }
                    },
                    onSnapEnd: function() {
                        board.position(game.fen());
                    }
                });
            }
            
            // Resize handler
            window.addEventListener('resize', () => {
                if (board) board.resize();
            });
            
            updateStatus();
        }

        function updateStatus() {
            var status = game.turn() === 'w' ? 'SÄ±ra Beyazda' : 'SÄ±ra Siyahda';
            if (game.in_checkmate()) status = "MAT! Oyun bitti.";
            else if (game.in_draw()) status = "Berabere!";
            else if (game.in_check()) status = (game.turn() === 'w' ? 'Beyaz' : 'Siyah') + ' ÅAH!';
            document.getElementById('status').innerText = status;
        }

        async function makeBestMove() {
            if (game.game_over()) return;
            
            const btn = document.getElementById('ai-move-btn');
            btn.disabled = true;
            document.getElementById('ai-thought').innerHTML = '<span class="pulse">ğŸ¦ Kaspar dÃ¼ÅŸÃ¼nÃ¼yor...</span>';
            
            try {
                const response = await fetch(`${getAPIUrl()}/move`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ fen: game.fen(), role: currentRole })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    game.move(data.best_move);
                    board.position(game.fen());
                    updateStatus();
                    document.getElementById('ai-thought').innerHTML = `ğŸ¦ <b>Kaspar:</b> ${data.comment}`;
                    
                    if (game.game_over() && game.in_checkmate()) {
                        saveGameResult(false); // Kaspar kazandÄ±
                    }
                } else {
                    document.getElementById('ai-thought').innerText = "Hata: " + (data.message || "Bilinmeyen hata");
                }
            } catch (err) {
                document.getElementById('ai-thought').innerText = "âŒ Beyne ulaÅŸÄ±lamadÄ±! BaÄŸlantÄ±yÄ± kontrol et.";
            }
            
            btn.disabled = false;
        }

        async function askKaspar() {
            document.getElementById('ai-thought').innerHTML = '<span class="pulse">ğŸ’­ Kaspar dÃ¼ÅŸÃ¼nÃ¼yor...</span>';
            
            try {
                const response = await fetch(`${getAPIUrl()}/hint`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({ fen: game.fen() })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('ai-thought').innerHTML = `ğŸ’¡ <b>Ä°pucu:</b> ${data.hint}`;
                } else {
                    document.getElementById('ai-thought').innerText = "ğŸ¦ Kaspar: 'Merkez kareleri kontrol etmeye odaklan ÅŸampiyon!'";
                }
            } catch (err) {
                document.getElementById('ai-thought').innerText = "ğŸ¦ Kaspar: 'Merkez kareleri kontrol etmeye odaklan ÅŸampiyon!'";
            }
        }

        function resetBoard() {
            game.reset();
            board.start();
            updateStatus();
            document.getElementById('ai-thought').innerText = "Merhaba Åampiyon! Yeni oyun baÅŸladÄ±. Hamle sÄ±rasÄ± sende.";
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

        // Ebeveyn GÃ¶rÃ¼nÃ¼mÃ¼
        async function initParentView() {
            // Grafik
            const ctx = document.getElementById('progressChart').getContext('2d');
            
            // localStorage'dan veri Ã§ek
            const stats = JSON.parse(localStorage.getItem('kaspar_stats') || '{"score":850,"wins":0,"games":0,"streak":0}');
            const history = JSON.parse(localStorage.getItem('kaspar_history') || '[]');
            
            // Son 7 gÃ¼nlÃ¼k aktivite (ÅŸimdilik simÃ¼le)
            const labels = ['Pzt', 'Sal', 'Ã‡ar', 'Per', 'Cum', 'Cmt', 'Paz'];
            const today = new Date().getDay();
            const reorderedLabels = [...labels.slice(today), ...labels.slice(0, today)];
            
            // GerÃ§ek veri yoksa Ã¶rnek gÃ¶ster
            const gameData = history.length > 0 ? history.slice(-7) : [0, 1, 0, 2, 1, 3, 2];
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: reorderedLabels,
                    datasets: [{
                        label: 'Oynanan Oyun',
                        data: gameData,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: '#f8fafc' } }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        },
                        x: { 
                            ticks: { color: '#94a3b8' },
                            grid: { color: '#334155' }
                        }
                    }
                }
            });
            
            // Ä°statistikler
            document.getElementById('parent-weekly-progress').textContent = stats.games > 0 ? `+${stats.games}` : '--';
            document.getElementById('parent-avg-time').textContent = '~15s';
            document.getElementById('parent-accuracy').textContent = stats.games > 0 ? `%${Math.round((stats.wins / Math.max(1, stats.games)) * 100)}` : '--%';
            
            // Aktivite listesi
            const activityList = document.getElementById('activity-list');
            if (stats.games > 0) {
                activityList.innerHTML = `
                    <div class="list-item"><span>ğŸ† Toplam Oyun</span><span>${stats.games}</span></div>
                    <div class="list-item"><span>âœ… KazanÄ±lan</span><span>${stats.wins}</span></div>
                    <div class="list-item"><span>ğŸ“ˆ Puan</span><span>${stats.score}</span></div>
                    <div class="list-item"><span>ğŸ”¥ Seri</span><span>${stats.streak}</span></div>
                `;
            } else {
                activityList.innerHTML = '<div class="list-item"><span>HenÃ¼z oyun oynanmadÄ±</span></div>';
            }
        }

        // MÃ¼hendis Paneli - CanlÄ± PowerPool Durumu
        var engineerPollingInterval = null;
        
        function startEngineerPolling() {
            updatePowerPoolStatus();
            updateSystemResources();
            engineerPollingInterval = setInterval(() => {
                updatePowerPoolStatus();
                updateSystemResources();
            }, 5000);
        }
        
        async function updateSystemResources() {
            try {
                const response = await fetch(`${getAPIUrl()}/system`, { headers: getHeaders() });
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('cpu-value').textContent = `${data.cpu}%`;
                    document.getElementById('cpu-bar').style.width = `${data.cpu}%`;
                    
                    document.getElementById('ram-value').textContent = `${data.ram}%`;
                    document.getElementById('ram-bar').style.width = `${data.ram}%`;
                    
                    document.getElementById('disk-value').textContent = `${data.disk}%`;
                    document.getElementById('disk-bar').style.width = `${data.disk}%`;
                }
            } catch (e) {
                // Fallback deÄŸerler
                document.getElementById('cpu-value').textContent = 'N/A';
                document.getElementById('ram-value').textContent = 'N/A';
                document.getElementById('disk-value').textContent = 'N/A';
            }
        }
        
        async function updatePowerPoolStatus() {
            const terminal = document.getElementById('terminal-output');
            
            try {
                const response = await fetch(`${getAPIUrl()}/powerpool`, { headers: getHeaders() });
                const data = await response.json();
                
                if (data.status === 'success') {
                    let output = '<div class="terminal-line" style="color:#0ff;">âš¡ POWERPOOL STATUS âš¡</div>';
                    output += `<div class="terminal-line">Aktif Batarya: ${data.active}/${data.total}</div>`;
                    output += `<div class="terminal-line">Toplam KullanÄ±m: ${data.total_usage}</div>`;
                    output += '<div class="terminal-line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>';
                    
                    data.batteries.forEach(b => {
                        const icon = b.active ? 'ğŸŸ¢' : 'ğŸ”´';
                        output += `<div class="terminal-line">${icon} ${b.email}</div>`;
                        output += `<div class="terminal-line" style="color:#888;">   KullanÄ±m: ${b.usage} | Hata: ${b.errors}</div>`;
                        output += `<div class="terminal-line" style="color:#888;">   Son: ${b.last_used}</div>`;
                    });
                    
                    output += '<div class="terminal-line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</div>';
                    output += `<div class="terminal-line" style="color:#0f0;">[${new Date().toLocaleTimeString()}] GÃ¼ncellendi âœ“</div>`;
                    
                    terminal.innerHTML = output;
                }
            } catch (err) {
                terminal.innerHTML = `<div class="terminal-line" style="color:#f00;">âŒ Brain API baÄŸlantÄ±sÄ± yok!</div>
                    <div class="terminal-line" style="color:#888;">Endpoint: ${getAPIUrl()}/powerpool</div>
                    <div class="terminal-line" style="color:#888;">Hata: ${err.message}</div>
                    <div class="terminal-line" style="color:#ff0;">Tailscale Funnel aktif mi kontrol et.</div>`;
            }
        }
        
        async function testAPI() {
            const terminal = document.getElementById('terminal-output');
            terminal.innerHTML = '<div class="terminal-line" style="color:#ff0;">ğŸ§ª API Test baÅŸlatÄ±lÄ±yor...</div>';
            
            const endpoints = ['status', 'powerpool', 'health'];
            let results = '';
            
            for (const ep of endpoints) {
                try {
                    const start = Date.now();
                    const response = await fetch(`${getAPIUrl()}/${ep}`, { headers: getHeaders() });
                    const elapsed = Date.now() - start;
                    const data = await response.json();
                    results += `<div class="terminal-line" style="color:#0f0;">âœ“ /${ep} - ${elapsed}ms - ${JSON.stringify(data).substring(0, 50)}...</div>`;
                } catch (e) {
                    results += `<div class="terminal-line" style="color:#f00;">âœ— /${ep} - ${e.message}</div>`;
                }
            }
            
            terminal.innerHTML = results;
        }
        
        // Sayfa kapatÄ±lÄ±rken polling'i durdur
        window.addEventListener('beforeunload', function() {
            if (engineerPollingInterval) clearInterval(engineerPollingInterval);
        });
    </script>
</body>
</html>
