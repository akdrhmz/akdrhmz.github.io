<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kaspar Satran√ß Akademisi</title>
    <!-- Chessboard.js & Chess.js -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <style>
        :root {
            --bg-color: #0f172a;
            --panel-bg: #1e293b;
            --accent-color: #38bdf8;
            --accent-green: #22c55e;
            --text-color: #f8fafc;
        }

        html, body {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden; touch-action: none; overscroll-behavior: none;
        }

        .app-container { display: flex; flex-direction: column; height: 100vh; max-width: 600px; margin: 0 auto; }
        .hidden { display: none !important; }

        /* MODALS */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .role-btn {
            background: var(--panel-bg); padding: 20px; margin: 10px; border-radius: 15px;
            width: 250px; text-align: center; cursor: pointer; border: 2px solid transparent;
            transition: 0.2s;
        }
        .role-btn:active { transform: scale(0.95); border-color: var(--accent-color); }
        
        .input-group { margin: 10px 0; width: 80%; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 1rem; text-align: center; }

        /* GAME UI */
        header {
            padding: 15px; background: var(--panel-bg); border-bottom: 1px solid #334155;
            display: flex; justify-content: space-between; align-items: center;
        }
        .user-badge { background: #334155; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; }

        .game-area { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 10px; gap: 15px; }
        
        .kaspar-bubble {
            background: var(--panel-bg); padding: 15px; border-radius: 12px;
            border-left: 4px solid var(--accent-color);
            display: flex; align-items: center; gap: 10px; font-size: 0.95rem;
            min-height: 60px;
        }
        
        .board-wrapper { width: 100%; aspect-ratio: 1; touch-action: none; }
        #board { width: 100%; height: 100%; border-radius: 8px; border: 3px solid #334155; }

        .controls { padding: 15px; display: flex; gap: 10px; background: var(--panel-bg); }
        .btn { background: var(--accent-color); color: #0f172a; border: none; padding: 12px; border-radius: 8px; font-weight: bold; flex: 1; cursor: pointer; }
        .btn-green { background: var(--accent-green); color: white; }

        /* PARENT UI */
        .student-list { width: 100%; padding: 20px; overflow-y: auto; }
        .student-item { background: var(--panel-bg); padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; cursor: pointer; }
        .student-item:hover { background: #334155; }
    </style>
</head>
<body>

    <!-- 1. Gƒ∞Rƒ∞≈û EKRANI -->
    <div id="screen-home" class="modal">
        <h1 style="color: var(--accent-color);">ü¶Å Kaspar</h1>
        <div class="role-btn" onclick="app.showAuth('student')">
            <div style="font-size: 3rem;">üéì</div>
            <h3>√ñƒürenci Giri≈üi</h3>
        </div>
        <div class="role-btn" onclick="app.showAuth('parent')">
            <div style="font-size: 2rem;">üè†</div>
            <h3>Ebeveyn Giri≈üi</h3>
        </div>
    </div>

    <!-- 2. AUTH EKRANI -->
    <div id="screen-auth" class="modal hidden">
        <h2 id="auth-title">Giri≈ü Yap</h2>
        <div class="input-group"><input type="text" id="username" placeholder="Kullanƒ±cƒ± Adƒ±"></div>
        <div class="input-group"><input type="password" id="password" placeholder="≈ûifre"></div>
        
        <div style="display:flex; gap:10px; width:80%;">
            <button class="btn" onclick="app.login()">Giri≈ü</button>
            <button class="btn btn-green" id="btn-register" onclick="app.register()">Kayƒ±t Ol</button>
        </div>
        <br>
        <button onclick="location.reload()" style="background:none; border:none; color:#94a3b8;">‚Üê Geri</button>
    </div>

    <!-- 3. OYUN EKRANI -->
    <div id="screen-game" class="app-container hidden">
        <header>
            <span style="font-weight:bold; color:var(--accent-color);">ü¶Å Arena</span>
            <div class="user-badge" id="game-username">Misafir</div>
        </header>

        <div class="game-area">
            <div class="kaspar-bubble">
                <span style="font-size: 2rem;">ü¶Å</span>
                <div id="kaspar-text">Merhaba! Hazƒ±rsan ba≈ülayalƒ±m.</div>
            </div>
            
            <div class="board-wrapper">
                <div id="board"></div>
            </div>
            
            <div style="text-align:center; color:#94a3b8; font-size:0.9rem;" id="game-status">Sƒ±ra Beyazda</div>
        </div>

        <div class="controls">
            <button class="btn" onclick="app.resetGame()">üîÑ Yeni Oyun</button>
            <button class="btn btn-green" onclick="app.askHint()">üí° ƒ∞pucu</button>
            <button class="btn" style="background:#ef4444; color:white;" onclick="location.reload()">√áƒ±kƒ±≈ü</button>
        </div>
    </div>

    <!-- 4. EBEVEYN EKRANI -->
    <div id="screen-parent" class="app-container hidden">
        <header>
            <span>üìä Veli Paneli</span>
            <button onclick="location.reload()" style="background:none; border:none; color:white;">√áƒ±kƒ±≈ü</button>
        </header>
        
        <div id="student-list" class="student-list">
            <!-- √ñƒürenci listesi buraya gelecek -->
            <div style="text-align:center; margin-top:20px;">√ñƒürenciler Y√ºkleniyor...</div>
        </div>

        <!-- Detay Modal -->
        <div id="report-modal" class="modal hidden">
            <div style="background:var(--panel-bg); padding:20px; border-radius:15px; width:90%; max-width:400px;">
                <h3 id="report-title" style="color:var(--accent-color);">Rapor</h3>
                <div id="report-content" style="margin:15px 0; line-height:1.5;"></div>
                <button class="btn" onclick="document.getElementById('report-modal').classList.add('hidden')">Kapat</button>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            apiKey: "kaspar_sec_eb82b49055236a3a862f42e53e8e8b97",
            apiUrl: "https://kadir-pc.taildc8da7.ts.net/api"
        };

        class App {
            constructor() {
                this.role = null;
                this.currentUser = null;
                this.game = new Chess();
                this.board = null;
                this.isThinking = false;
            }

            showAuth(role) {
                this.role = role;
                document.getElementById('screen-home').classList.add('hidden');
                document.getElementById('screen-auth').classList.remove('hidden');
                document.getElementById('auth-title').innerText = role === 'student' ? '√ñƒürenci Giri≈üi' : 'Veli Giri≈üi';
                
                // Veli i√ßin kayƒ±t butonunu gizle (Manuel eklenir)
                if (role === 'parent') document.getElementById('btn-register').classList.add('hidden');
                else document.getElementById('btn-register').classList.remove('hidden');
            }

            async login() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                if(!username || !password) return alert("L√ºtfen bilgileri girin.");

                try {
                    const res = await this.apiCall('/auth/login', { username, password });
                    if (res.status === 'success') {
                        this.currentUser = res;
                        this.startSession();
                    } else {
                        alert(res.message);
                    }
                } catch(e) { alert("Baƒülantƒ± hatasƒ±!"); }
            }

            async register() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                if(!username || !password) return alert("Kullanƒ±cƒ± adƒ± ve ≈üifre belirleyin.");

                try {
                    const res = await this.apiCall('/auth/register', { 
                        username, password, role: 'student' 
                    });
                    if (res.status === 'success') {
                        alert("Kayƒ±t ba≈üarƒ±lƒ±! ≈ûimdi giri≈ü yapabilirsin.");
                    } else {
                        alert(res.message);
                    }
                } catch(e) { alert("Kayƒ±t hatasƒ±!"); }
            }

            startSession() {
                document.getElementById('screen-auth').classList.add('hidden');
                if (this.role === 'student') {
                    document.getElementById('screen-game').classList.remove('hidden');
                    document.getElementById('game-username').innerText = this.currentUser.username;
                    setTimeout(() => this.initBoard(), 200);
                } else {
                    document.getElementById('screen-parent').classList.remove('hidden');
                    this.loadStudents();
                }
            }

            // --- OYUN MANTIƒûI ---
            initBoard() {
                if(this.board) this.board.destroy();
                
                this.board = Chessboard('board', {
                    draggable: true,
                    position: 'start',
                    pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                    onDragStart: (s, p) => !this.isThinking && !this.game.game_over() && (this.game.turn() === 'w' || p.search(/^b/) === -1),
                    onDrop: (s, t) => {
                        const move = this.game.move({ from: s, to: t, promotion: 'q' });
                        if (!move) return 'snapback';
                        this.updateStatus();
                        if (!this.game.game_over()) this.makeAiMove();
                        else this.endGame();
                    }
                });
                
                // Mobil hack
                document.getElementById('board').addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
                window.addEventListener('resize', () => this.board.resize());
            }

            async makeAiMove() {
                this.isThinking = true;
                document.getElementById('kaspar-text').innerText = "D√º≈ü√ºn√ºyorum...";
                
                try {
                    const res = await this.apiCall('/move', { 
                        fen: this.game.fen(),
                        user_id: this.currentUser.user_id 
                    });
                    
                    if (res.status === 'success') {
                        this.game.move(res.best_move, { sloppy: true });
                        this.board.position(this.game.fen());
                        document.getElementById('kaspar-text').innerText = res.comment;
                    }
                } catch(e) {
                    console.error(e);
                } finally {
                    this.isThinking = false;
                    this.updateStatus();
                    if(this.game.game_over()) this.endGame();
                }
            }
            
            async endGame() {
                let result = 'draw';
                if(this.game.in_checkmate()) result = this.game.turn() === 'w' ? 'loss' : 'win';
                
                await this.apiCall('/game/end', {
                    user_id: this.currentUser.user_id,
                    result: result,
                    moves: this.game.history().length
                });
                
                document.getElementById('kaspar-text').innerHTML = `<b>OYUN Bƒ∞TTƒ∞!</b> (${result === 'win' ? 'Kazandƒ±n!' : 'Kaybettin'})`;
            }

            updateStatus() {
                let status = this.game.turn() === 'w' ? "Sƒ±ra Beyazda" : "Sƒ±ra Siyahda";
                if(this.game.in_check()) status += " (≈ûAH!)";
                document.getElementById('game-status').innerText = status;
            }

            resetGame() {
                this.game.reset();
                this.board.start();
                this.updateStatus();
                document.getElementById('kaspar-text').innerText = "Yeni oyun ba≈üladƒ±! Ba≈üarƒ±lar " + this.currentUser.username;
            }
            
            async askHint() {
                const res = await this.apiCall('/hint', { fen: this.game.fen() });
                if(res.status === 'success') alert("ƒ∞pucu: " + res.hint);
            }

            // --- PARENT MANTIƒûI ---
            async loadStudents() {
                const res = await this.apiCall('/parent/students');
                const list = document.getElementById('student-list');
                list.innerHTML = '';
                
                if(res.students) {
                    res.students.forEach(s => {
                        const div = document.createElement('div');
                        div.className = 'student-item';
                        div.innerHTML = `<span>üéì ${s.username}</span><span>Level ${s.current_level}</span>`;
                        div.onclick = () => this.showReport(s.id);
                        list.appendChild(div);
                    });
                }
            }

            async showReport(studentId) {
                const modal = document.getElementById('report-modal');
                const content = document.getElementById('report-content');
                modal.classList.remove('hidden');
                content.innerHTML = 'Rapor hazƒ±rlanƒ±yor...';
                
                const res = await this.apiCall('/parent/report', { student_id: studentId });
                content.innerHTML = `
                    <p><b>Toplam Oyun:</b> ${res.total_games}</p>
                    <p><b>Galibiyet:</b> ${res.wins}</p>
                    <hr style="border:1px solid #444; margin:10px 0;">
                    <p><i>"${res.kaspar_comment}"</i></p>
                `;
            }

            // --- API HELPER ---
            async apiCall(endpoint, body={}) {
                const res = await fetch(`${CONFIG.apiUrl}${endpoint}`, {
                    method: 'POST', // GET isteyenleri ayƒ±rmadƒ±m, hepsi POST basitle≈ütirdim (Backend'de hepsi POST deƒüilse patlar, kontrol edelim)
                    headers: { 'Content-Type': 'application/json', 'X-Kaspar-Key': CONFIG.apiKey },
                    body: endpoint.includes('students') ? null : JSON.stringify(body) // GET i√ßin body yok
                });
                
                // Fetch metodunu GET i√ßin d√ºzeltelim
                if (endpoint === '/parent/students') {
                     const r = await fetch(`${CONFIG.apiUrl}${endpoint}`, { headers: { 'X-Kaspar-Key': CONFIG.apiKey } });
                     return await r.json();
                }

                return await res.json();
            }
        }

        window.app = new App();
    </script>
</body>
</html>
